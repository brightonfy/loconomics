@using WebMatrix.Data;
@using System.Text;
@{
    var logger = PageData["Logger"] = new StringBuilder();
    var elapsedTime = DateTime.Now;

    int messages = 0, items = 0;
    int totalmessages = 0, totalitems = 0;
    using(var db = Database.Open("sqlloco")){
        /*
         * Check:: Booking Request timed out
         * If:: A not complete booking request exist without changes from more than 1 day
         * Action:: Set as timedout, invalidating the request and its data
         */
        messages = 0;
        items = 0;
        foreach (var br in db.Query(@"
                SELECT  BookingRequestID
                FROM    BookingRequest
                WHERE   BookingRequestStatusID = 1 -- created but not completed
                         AND
                        -- is old enought to be considered not active
                        UpdatedDate < dateadd(d, -1, getdate())
            ")){
            try {
                // RequestStatusID:3:timed out
                LcData.Booking.InvalidateBookingRequest(br.BookingRequestID, 3);

                items++;
                messages += 2;
            } catch (Exception ex){
                logEx("Requests Timed-out", ex);
            }
        }
        log("Total invalidated as TimedOut Booking Requests: {0}, messages sent: {1}", items, messages);
        totalitems += items;
        totalmessages += messages;
        
        /*
         * Check:: Booking Request expiration
         * If:: Provider didn't reply
         * If:: Request not updated/changed
         * Action:: Set as expired, un-authorize/return money to customer, notify
         */
        messages = 0;
        items = 0;
        foreach (var br in db.Query(@"
                SELECT  BookingRequestID
                FROM    BookingRequest
                WHERE   BookingRequestStatusID = 2 -- request created and completed, without provider answer
                         AND
                        -- passed 18 hours from request or some change (some provider communication or customer change)
                        UpdatedDate < dateadd(hh, -18, getdate())
            ")){
            try {
                // RequestStatusID:6:expired
                var result = LcData.Booking.InvalidateBookingRequest(br.BookingRequestID, 6);
                if (result.Error == 0) {
                    // Send message
                    LcMessaging.SendBookingRequestInvalidation(br.BookingRequestID, 1, 19);
                }
                
                items++;
                messages += 2;
            } catch (Exception ex){
                logEx("Requests Expired", ex);
            }
        }
        log("Total invalidated as Expired Booking Requests: {0}, messages sent: {1}", items, messages);
        totalitems += items;
        totalmessages += messages;
        
        /*
         * Check:: 24H Booking Reminder
         * If:: Confirmated bookings not cancelled
         * If:: Current time is 24 hours before Confirmed Service DateTime
         * Action:: send a booking reminder email
         */
        messages = 0;
        items = 0;
        foreach (var b in db.Query(@"
                SELECT  BookingID
                FROM    Booking As B
                         INNER JOIN
                        CalendarEvents As E
                          ON B.ConfirmedDateID = E.Id
                WHERE   BookingStatusID = 1 -- confirmed, not cancelled and not other changes
                         AND
                        -- at 24 hours from request (between 25 and 24 hours)
                        getdate() > dateadd(hh, -25, E.StartTime)
                         AND
                        getdate() <= dateadd(hh, -24, E.StartTime)
            ")){
            try {
                // Send message
                // TODO: Send a more specific reminder message, instead a simple copy of
                // current booking state
                LcMessaging.SendBookingUpdate(b.BookingID, 's');

                items++;
                messages += 2;
            } catch (Exception ex){
                logEx("Booking 24H Reminders", ex);
            }
        }
        log("Total of Booking 24H Reminders: {0}, messages sent: {1}", items, messages);
        totalitems += items;
        totalmessages += messages;
        
        /*
         * Check:: Booking Review Reminder
         * If:: Confirmed bookings not cancelled
         * If:: User 
         * If:: Current time is 8AM on the day after the Confirmed Service DateTime
         * Action:: send a booking review reminder email
         */
        messages = 0;
        items = 0;
        foreach (var b in db.Query(@"
                SELECT  B.BookingID,
                        CAST(CASE WHEN (SELECT count(*) FROM UserReviews As URP
                            WHERE URP.BookingID = B.BookingID
                                AND
                                URP.ProviderUserID = R.ProviderUserID
                                AND 
                                URP.PositionID = 0
                        ) = 0 THEN 0 ELSE 1 END As bit) As ReviewedByProvider,
                        CAST(CASE WHEN (SELECT count(*) FROM UserReviews As URC
                            WHERE URC.BookingID = B.BookingID
                                AND
                                URC.CustomerUserID = R.CustomerUserID
                                AND 
                                URC.PositionID = R.PositionID
                        ) = 0 THEN 0 ELSE 1 END As bit) As ReviewedByCustomer
                FROM    BookingRequest As R
                         INNER JOIN
                        Booking As B
                          ON R.BookingRequestID = B.BookingRequestID
                         INNER JOIN
                        CalendarEvents As E
                          ON B.ConfirmedDateID = E.Id
                WHERE   B.BookingStatusID = 1 -- confirmed, not cancelled and not other changes
                         AND
                        -- at 8AM hours
                        datepart(hh, getdate()) = 12
                         AND
                        -- of the day after the service
                        Cast(dateadd(d, -1, getdate()) As Date) = Cast(E.EndTime As Date)
            ")){
            try {
                // We need check that there was not reviews already (why send a reminder for something
                // already done? just we avoid that!).
                // If both users did its reviews, nothing to send
                if (b.ReviewedByProvider && b.ReviewedByCustomer) {
                    // Next booking
                    continue;
                }
                char messageFor = 
                    b.ReviewedByProvider ? 'c' : 
                    b.ReviewedByCustomer ? 'p' : 
                    'b';

                // Send message
                // TODO: Send a more specific reminder message, instead a simple copy of
                // current booking state (that at this moment must show the review button)
                LcMessaging.SendBookingUpdate(b.BookingID, 's', messageFor);

                items++;
                if (messageFor == 'c' || messageFor == 'p') {
                    messages++;
                } else {
                    messages+=2;
                }
            } catch (Exception ex){
                logEx("Booking Review Reminders", ex);
            }
        }
        log("Total of Booking Review Reminders: {0}, messages sent: {1}", items, messages);
        totalitems += items;
        totalmessages += messages;
    }
    
    log("Elapsed time for this last tasks batch: {0}, for {1} items and {2} messages", DateTime.Now - elapsedTime, totalitems, totalmessages);

    // Finishing: save log on disk
    try {
        System.IO.File.AppendAllText(Server.MapPath(UrlUtil.RenderAppPath + "_logs/ScheduledTaskLog.txt"), logger.ToString());
    }catch {
    }
    
    // TODO: log file maintenance: daily/weekly? rotation and deletion of very old ones. Careful with total size.
}
@functions{
    void log(string format, params object[] pars){
        StringBuilder logger = PageData["Logger"];
        // Universal date-time, following ISO8601 format with Z identifier at the end
        logger.AppendFormat("{0:s}Z ", DateTime.Now.ToUniversalTime());
        logger.AppendFormat(format, pars);
        logger.Append("\n");
    }
    void logEx(string task, Exception ex){
        log("{1}: Exception {2}\n", task, ex.Message);
    }
}
@if (!LcHelpers.InProduction)
{
    Response.ContentType = "text/plain";
    @logger.ToString()
}
