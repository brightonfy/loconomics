@using WebMatrix.Data;
@{
    System.Text.StringBuilder log = new System.Text.StringBuilder();

    using(var db = Database.Open("sqlloco")){
        /*
         * Checking timeouts booking requests and invalide.
         */
        foreach (var br in db.Query(@"
                SELECT  BookingRequestID
                FROM    BookingRequest
                WHERE   BookingRequestStatusID = 1 -- created but not completed
                         AND
                        -- is old enought to be considered not active
                        UpdatedDate < dateadd(d, -1, getdate())
            ")){
            try{
                LcData.Booking.InvalidateBookingRequest(br.BookingRequestID, 3);
            }catch (Exception ex){
                log.AppendFormat("{0} {1}: Exception {2}\n", DateTime.Now, "Requests Timeout", ex.Message);
            }
        }
    }
    
    // Finishing: save log on disk
    try {
        System.IO.File.AppendAllText("_ScheduledTaskLog.txt", log.ToString());
    }catch {
    }
}