@using WebMatrix.Data;
@*
    Route a booking from external link to the given provider-position
    reserved code.
*@
@{
    var bookcode = UrlData[0];
    using (var db = Database.Open("sqlloco")){
        // Code per user
        var userid = db.QueryValue(@"
            SELECT  UserID
            FROM    Users
            WHERE   BookCode = @0
        ", bookcode);

        if (userid is int) {
            Session["BookCode"] = bookcode;
            Response.Redirect(LcData.UserInfo.GetUserPublicURL(userid));
        }
        
        // Code per position
        var userpos = db.QuerySingle(@"
            SELECT  UserID, PositionID
            FROM    UserProfilePositions
            WHERE   BookCode = @0
        ", bookcode);

        if (userpos != null) {
            Response.Redirect(LcUrl.LangPath + "Booking/?ProviderID=" + userpos.UserID + "&PositionID=" + userpos.PositionID + "&BookCode=" + bookcode);
        }
    }
    // Not found custom URL, this URL page doesn't exist, transfer to Not Found
    @RenderPage(LcUrl.RenderAppPath + "Errors/Error404.cshtml");
}
