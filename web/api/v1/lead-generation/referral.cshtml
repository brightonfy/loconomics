@using WebMatrix.WebData;
@**
    Lead Generation: Referral API.
    
    It lets anonymous users to refer service professionals, in a process of three steps:
    - Subscribe itsefs to Loconomics newsletter just with email, getting registered as a user without enabled account.
    - Optionally provide first and last name (as independent step --updates profile created at first step)
    - Refer professionals with first name and maybe phone, email, lastName

    # Referral - Step 1: Subscribe client with email

    ## REST API
    POST /lead-generation/referral/subscribe
    - email:string
    - isServiceProfessional:boolean

    ## Restrictions
    - Only available to anonymous users (UI should prevent allowing this request to logged users)
    - All input data is required
    - Validate email format
    - Email does not exists

    ## Storage
    At [userprofile]:
    - userID: [auto]
    - email: data.email

    At [users]:
    - userID: userprofile.userID
    - isServiceProfessional: data.isServiceProfessional
    - isClient: true
    - accountStatusID: -1
    - loconomicsMarketingCampaigns: true
    - firstName: ''
    - middleIn: ''
    - lastName: ''
    - secondLastName: ''
    - marketingSource: context.url.queryString + '&lead-generation=referral'
    - preferredLanguageID: context.locale.languageID
    - preferredCountryID: context.locale.countryID
    - createdDate: DateTime.Now
    - updatedDate: DateTime.Now
    - active: true

    ## Result
    - userID:int

    ## Triggers
    - Send e-mail "Subscribed to Loconomics newsletter"  *disabled for now, waiting for later template implementation*

    # Referral - Step 2: Update client with name

    ## REST API
    PUT /lead-generation/referral/subscribe
    - userID:int
    - email:string
    - firstName:string
    - lastName:string

    ## Restrictions
    - Only available to anonymous users (UI should prevent allowing this request to logged users)
    - All input data is required
    - Check that userID and email exists and matches the same user (it prevents from sending random IDs in the request, since this calls are anonymous, and we cannot validate a user session for the subscribed client because is not an active and password enabled account still).

    ## Storage
    Update [users] Where
    - userID = data.userID
    Set:
    - isServiceProfessional: data.isServiceProfessional
    - firstName: data.firstName
    - lastName: data.lastName
    - updatedDate: DateTime.Now

    ## Result
    "OK"

    # Referral - Step 3: Refer service professional

    ## REST API
    POST /lead-generation/referral/refer
    - email:string [Optional]
    - firstName:string
    - lastName:string [Optional]
    - phone:string [Optional]
    - referredByUserID:int [Required for anonymous user]
    - referredByEmail:string [Required for anonymous user]

    ## Restrictions
    - Validate email format
    - Email does not exists
    - Despite that 'email' and 'phone' are optional, almost one of them is required.
    - **For anonymous users:** Check that referredByUserID and referredByEmail exists and matches the same user (it prevents from sending random IDs in the request, since this calls are anonymous, and we cannot validate a user session for the subscribed client because is not an active and password enabled account still).
    - **For logged users:** values referredByUserID and referredByEmail are not required and not used on this case, we use the the userID of the logged user.

    ## Storage
    At [userprofile]:
    - userID: [auto]
    - email: data.email or [autogenerated non-email (a value is required and must be unique)]

    At [users]:
    - userID: userprofile.userID
    - isServiceProfessional: true
    - isClient: true
    - accountStatusID: -1
    - referredByUserID: [when anonymous] data.referredByUserID [when logged user] context.user.userID
    - loconomicsMarketingCampaigns: true
    - firstName: data.firstName
    - middleIn: ''
    - lastName: data.lastName
    - secondLastNme: ''
    - mobilePhone: data.phone
    - marketingSource: context.url.queryString + '&lead-generation=referral'
    - preferredLanguageID: context.locale.languageID
    - preferredCountryID: context.locale.countryID
    - createdDate: DateTime.Now
    - updatedDate: DateTime.Now
    - active: true

    ## Result
    "OK"

    ## Triggers
    - Send e-mail "Thank you! You have referred [service professional.firstName]" *disabled for now until email templates are implemented*


    ## EXAMPLES {
        "Lead Generation: subscribe to newsletter": {
            "url": "/api/v1/en-US/lead-generation/newsletter/subscribe",
            "post": {
                "email": "user@test.one",
                "isServiceProfessional": true
            }
        }
    }
**@
@functions{
    public class RestLeadGenerationNewsletter : RestWebPage
    {
        public override dynamic Post()
        {
            if (UrlData.Count == 1 && UrlData[0] == "subscribe")
            {
                if (WebSecurity.IsAuthenticated)
                {
                    throw new HttpException(400, "You are already logged in!");
                }
                Validation.RequireField("email", LcRessources.RequiredField("E-mail"));
                Validation.Add("email",
                    Validator.Regex(LcValidators.EmailAddressRegexPattern, "The email is not valid."));
                if (!Request.Form["isServiceProfessional"].IsBool())
                {
                    ModelState.AddError("isServiceProfessional", "Is required to indicate whether is service professional or not");
                }
                if (Validation.IsValid() && ModelState.IsValid)
                {
                    var email = Request.Form["email"];
                    var isServiceProfessional = Request.Form["isServiceProfessional"].AsBool();
                    var marketingSource = Request.Url.Query;
                    var additionalSource = "&lead-generation=referral";
                    marketingSource = (marketingSource ?? "") + additionalSource;
                    var userID = LcRest.LeadGeneration.SubscribeNewUser(email, isServiceProfessional, marketingSource, LcRest.Locale.Current);
                    if (userID > 0)
                    {
                        //LcMessaging.SendNewsletterSubscriptionFromReferral(userID, email);
                        return "OK";
                    }
                    else
                    {
                        throw new HttpException(500, "Subscription failed");
                    }
                }
                else
                {
                    throw new HttpException(400, LcRessources.ValidationSummaryTitle);
                }
            }
            return base.Post();
        }
    }
    }
@{
    // Public access
    new RestLeadGenerationNewsletter().JsonResponse(this);
}