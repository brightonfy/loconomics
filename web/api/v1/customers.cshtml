@using WebMatrix.WebData;
@*
    Accessing the current user (freelancer) customers list.

    Options:
    
    - GET: get all the customers of the freelancer user requesting the data

    - GET /@customerUserID: get the customer information for the given userID and the freelancer user requesting the data

    - GET /search: Public search of users know externally by the freelancer with exact match of one of the optional identifiable fields: fullName, email, phone.
        The set of results does not exists as frelancer's customers, so control fields are null ever (createdDate, updatedDate) and Editable is false.

    - POST: create a new customer. Pass in all fields of class LsRestCustomer less the control fields, 'freelancerUserID' and the 'editable' field.
        A look up by email and phone are performed (exact macth) so not duplicated records can happens, throwing a Conflict HTTP error that provides the public
        data for the customer that already exists (the data that can be extracted, default for others fields --like notesAboutCustomer field).

    - PUT /@customerUserID: Update a customer record. customerUserID and freelancerUserID, additionally to control fields and 'editable' field, are not editable
        so they are discarded if specified.
        An bad requets HTTP error is throw if freelancer (current user) has no rights to modify the data (on client side, 
        the 'editable' field can be checked before PUT the data, but even on extreme cases can happen than an initially editable customer becomes
        not editable when attempting the request -user account status changes, as customer enabling its marketplace account from a freelancer record)

    - DELETE /@customerUserID

    - @Result list or item of type LcRestCustomer
*@
@functions{
    public class RestCustomers : RestWebPage
    {
        public override dynamic Get()
        {
            if (UrlData.Count == 0) {
                var freelancerUserID = WebSecurity.CurrentUserId;
                return LcRestCustomer.GetFreelancerCustomers(freelancerUserID);
            }
            else if (UrlData.Count == 1 &&
                UrlData[0].IsInt()) {
                var freelancerUserID = WebSecurity.CurrentUserId;
                var customerUserID = UrlData[0].AsInt();
                var customer = LcRestCustomer.GetFreelancerCustomer(freelancerUserID, customerUserID);
                if (customer != null) {
                    return customer;
                }
            }
            else if (UrlData.Count == 1 &&
                UrlData[0] == "public-search") {
                var freelancerUserID = WebSecurity.CurrentUserId;
                return LcRestCustomer.PublicSearch(freelancerUserID, Request.QueryString["fullName"], Request.QueryString["email"], Request.QueryString["phone"]);
            }

            throw new HttpException(404, "Not Found");
        }

        public override dynamic Post()
        {
            if (UrlData.Count == 0) {
                var freelancerUserID = WebSecurity.CurrentUserId;
                // Create new customer
                return SetCustomer(freelancerUserID);
            }

            // method not allowed
            return base.Post();
        }

        public override dynamic Put()
        {
            if (UrlData.Count == 1 &&
                UrlData[0].IsInt()) {
                
                var freelancerUserID = WebSecurity.CurrentUserId;
                var itemID = UrlData[0].AsInt();
                
                if (itemID == 0) {
                    // Not allowed
                    return base.Put();
                }

                // Update customer by ID
                return SetCustomer(freelancerUserID, itemID);
            }

            // method not allowed
            return base.Put();
        }

        public override dynamic Delete()
        {
            if (UrlData.Count == 1 &&
                UrlData[0].IsInt()) {

                var freelancerUserID = WebSecurity.CurrentUserId;
                var itemID = UrlData[0].AsInt();
                
                // Get a copy before deletio to send later
                var item = LcRestCustomer.GetFreelancerCustomer(freelancerUserID, itemID);

                if (item == null) {
                    throw new HttpException(404, "Not Found");
                }

                // Delete
                LcRestCustomer.Delete(freelancerUserID, itemID);

                return item;
            }
            
            // method not allowed
            return base.Delete();
        }
        
        private bool IsValidCustomer() {

            Validation.RequireField("firstName", LcRessources.RequiredField("First Name"));
            Validation.RequireField("lastName", LcRessources.RequiredField("Last Name"));
            Validation.RequireField("email", LcRessources.RequiredField("Last Name"));
            Validation.Add("birthMonth", Validator.Integer("Birth Month must be a number"));
            Validation.Add("birthMonth", Validator.Range(1, 12, "Birth Month must be a number between 1 and 12"));
            Validation.Add("birthMonthDay", Validator.Integer("Birth Month Day must be a number"));
            Validation.Add("birthMonthDay", Validator.Range(1, 31, "Birth Month Day must be a number between 1 and 31"));
            Validation.Add("firstName", Validator.StringLength(50, 0, "First Name must be fewer than 50 characters."));
            Validation.Add("lastName", Validator.StringLength(145, 0, "Last Name must be fewer than 145 characters."));
            Validation.Add("secondLastName", Validator.StringLength(145, 0, "Second Last Name must be fewer than 145 characters."));
            Validation.Add("email", Validator.Regex(LcValidators.EmailAddressRegexPattern, "That e-mail is not valid"));
           
            return Validation.IsValid() && ModelState.IsValid;
        }
        
        private LcRestCustomer SetCustomer(int freelancerUserID, int customerUserID = 0) {
            // Validation
            if (!IsValidCustomer()) {
                throw new HttpException(400, LcRessources.ValidationSummaryTitle);
            }

            var customer = GetCustomerFromForm();
            customer.customerUserID = customerUserID;
            var itemID = LcRestCustomer.SetCustomer(freelancerUserID, customer);

            // If returned ID is zero rather than the provided one
            // is because the requested ID was not found.
            // (for cases of new, when passed ID is zero, the returned is the 
            // new generated ID, so is not zero if created successfully).
            if (itemID == 0) {
                throw new HttpException(404, "Not Found");
            }
                
            // Returns the updated customer data
            return LcRestCustomer.GetFreelancerCustomer(freelancerUserID, itemID);
        }
        
        private LcRestCustomer GetCustomerFromForm()
        {
            var customer = new LcRestCustomer {
                firstName = Request.Form["firstName"],
                lastName = Request.Form["lastName"],
                secondLastName = Request.Form["secondLastName"],
                email = Request.Form["email"],
                phone = Request.Form["phone"],
                canReceiveSms = Request.Form["canReceiveSms"].AsBool(),
                birthMonth = Request.Form["birthMonth"].AsInt(),
                birthMonthDay = Request.Form["birthMonthDay"].AsInt(),
                notesAboutCustomer = Request.Form["notesAboutCustomer"]
            };

            return customer;
        }
    }
}
@{
    Response.RestRequiresUser(LcData.UserInfo.UserType.Provider);
    new RestCustomers().JsonResponse(this);
}
