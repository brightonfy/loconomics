@*
    This page is called to populate a JSON object with the Position Singular values available for a given Language and Country

    INPUT:
        serviceType
        languageID
        countryID
*@
@using WebMatrix.Data;
@{
    // Prepare result struct
    var result = new Dictionary<string, object>();
    int resultCode = -1;
 
    try{
        // Input data
        var term = Request["serviceType"] ?? Request["term"];
    
        // Process data
        var db = Database.Open("sqlloco");
        var sql = "EXEC SearchPositions @0,@1,@2";
        var data = db.Query(sql, "%" + term + "%", LcData.GetCurrentLanguageID(), LcData.GetCurrentCountryID());

        // Result format is different to feed the Autocomplete jQueryUI feature:
        if (UrlData.Count > 0 && UrlData[0].ToLower() == "autocomplete") {
            LcHelpers.ReturnJson(
                data.Select(p => new{label = term + " (" + p.PositionSingular + ")", value = p.PositionID, positionSingular = p.PositionSingular, description = p.PositionDescription})
            );
        }
        
        result["Positions"] = data;
        
        //throw new Exception("Inside Test error");
        
        // Success
        resultCode = 0;

    } catch(Exception ex){
        result["ErrorMessage"] = ex.Message;
    }
    
    // Output data
    LcHelpers.ReturnJsonResult(resultCode, result);
}