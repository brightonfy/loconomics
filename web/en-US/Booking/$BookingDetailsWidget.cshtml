@using WebMatrix.Data;
@using WebMatrix.WebData;
@{
    LcHelpers.SecurePage();
    
    // Page variables
    var u = LcData.UserInfo.GetUserRow();
    dynamic booking = null;
    bool isRequest = false;
    var prefix = "";
    DateTime confirmationLimitDate = DateTime.MaxValue;
    LcData.Address address = null;
    int itsUserID = 0;
    var itsUserType = LcData.UserInfo.UserType.Customer;
    var myUserType = LcData.UserInfo.UserType.Provider;
    dynamic itsUserData = null;
    dynamic itsPositionData = null;
    var title = "";
    DateTime? bookingDate = null;
    dynamic pricingSummary = null, pricingSummaryDetails = null;
    
    // Setting up data
    {
        var brID = Request["BookingRequestID"];
        var bID = Request["BookingID"];
        
        if (!String.IsNullOrEmpty(bID)) {
            // Confirmed Booking
            prefix = "booking-" + bID;
            booking = LcData.Booking.GetBookingForUser(bID.AsInt(), u.UserID, u.IsAdmin);
        } else {
            // Booking Request
            isRequest = true;
            prefix = "booking-request-" + brID;
            booking = LcData.Booking.GetBookingRequestForUser(brID.AsInt(), u.UserID, u.IsAdmin);
            if (booking != null) {
                confirmationLimitDate = booking.UpdatedDate.AddHours(LcData.Booking.ConfirmationLimitInHours);
            }
        }
        
        if (booking != null) {
            
            if (!isRequest) {
                address = new LcData.Address(booking);
                address.Name = String.IsNullOrWhiteSpace(booking.LocationName)
                    ? ""
                    : booking.LocationUserFirstName + "'s " + booking.LocationName;
            }
            
            // Provider or customer?
            if (WebSecurity.CurrentUserId == booking.CustomerUserID) {
                itsUserType = LcData.UserInfo.UserType.Provider;
                myUserType = LcData.UserInfo.UserType.Customer;
                itsUserID = booking.ProviderUserID;
                itsPositionData = LcData.UserInfo.GetUserPos(itsUserID, booking.PositionID);
            } else {
                itsUserID = booking.CustomerUserID;
            }
            itsUserData = isRequest
                ? LcData.UserInfo.GetUserRow(itsUserID)
                : LcData.UserInfo.GetUserRowWithContactData(itsUserID);

            // Some labels
            // Fixed title right now, instead of the one depending on state and users
            title = "Booking Summary";
            /*title = isRequest
                ? LcData.Booking.GetBookingRequestTitleFor(booking.BookingRequestStatusID, itsUserData, itsUserType)
                : LcData.Booking.GetBookingTitleFor(booking.BookingStatusID, itsUserData, itsUserType);
            */

            // Expected booking date, for use on several languages
            bookingDate = isRequest
                ? booking.PreferredDateStart
                : booking.ConfirmedDateStart;
            if (isRequest)
            {
                if (booking.AlternativeDate1Start is DateTime &&
                    booking.AlternativeDate1Start < bookingDate)
                {
                    bookingDate = booking.AlternativeDate1Start;
                }
                if (booking.AlternativeDate2Start is DateTime &&
                    booking.AlternativeDate2Start < bookingDate)
                {
                    bookingDate = booking.AlternativeDate2Start;
                }
            }
            
            // Pricing summary data
            pricingSummary = LcData.Booking.GetPricingSummary(booking);
            //pricingSummaryGroups = LcData.Booking.GetPricingSummaryGroups(booking.PricingEstimateID, summary);
            pricingSummaryDetails = LcData.Booking.GetPricingSummaryDetails(booking.PricingEstimateID, booking.PricingEstimateRevision);
        }
    }
}
<div class="w-BookingDetails @(isRequest ? "is-request booking-request" : "booking")">
@if (booking == null)
{
    @(isRequest
        ? "Sorry, we could not find the requested booking."
        : "You have no bookings. Book one today!"
    )
}
else
{
    <div class="w-BookingDetails-header">
        <h3 class="w-BookingDetails-title">@title</h3>
        @*<span class="updateddate">last updated: @booking.UpdatedDate.ToLongDateString() at @booking.UpdatedDate.ToLongTimeString()</span>*@

        @RenderPage("$BookingActions.cshtml", new {
            MyUserType = myUserType,
            BookingData = booking,
            IdPrefix = prefix,
            IsRequest = isRequest
        })

        @RenderPage(LcUrl.RenderLangPath + "Profile/$UserInfoWidget.cshtml", new { 
            Data = itsUserData,
            Size = "mini-position",
            UserType = itsUserType,
            WithContactData = false,
            WithLinkInName = true,
            PositionData = itsPositionData
        })
    </div>
    <div class="w-BookingDetails-content">

        <h4 class="c-SectionTitle">Status</h4>
        @RenderPage("$BookingStatusIntro.cshtml", new {
            BookingData = booking,
            MyUserType = myUserType,
            ItsUserData = itsUserData,
            MyUserData = u,
            ConfirmationLimitDate = confirmationLimitDate,
            ShowGreetings = false,
            IsRequest = isRequest
        })

        @if (isRequest)
        {
            <h4 class="c-SectionTitle">Time preferences</h4>
            @RenderPage("$BookingRequestedTimes.cshtml", new {
                BookingData = booking,
                MyUserType = myUserType
            })
        }

        <h4 class="c-SectionTitle">Payment</h4>
        <div class="payment">
            @LcData.Booking.GetBookingPaymentInformation(booking, myUserType)
        </div>

        <h4 class="c-SectionTitle">Pricing Summary</h4>
        @if (myUserType == LcData.UserInfo.UserType.Provider)
        {
            @LcPricingView.ProviderPricingSummaryDetailed(pricingSummary, pricingSummaryDetails)
        }
        else if (myUserType == LcData.UserInfo.UserType.Provider)
        {
            @LcPricingView.CustomerPricingSummaryDetailed(pricingSummary, pricingSummaryDetails)
        }

        <h4 class="c-SectionTitle">Services</h4>
        <div class="w-BookingDetails-packages">
            @RenderPage("$BookingPricingPackages.cshtml", new
               {
                   BookingData = booking
               })
        </div>

        @if (!String.IsNullOrWhiteSpace(booking.SpecialRequests)) {
            <h4 class="c-SectionTitle">Notes for @LcData.UserInfo.GetUserRow(booking.ProviderUserID).FirstName</h4>
            <p class="special-instructions">@booking.SpecialRequests</p>
        }

        @if (!isRequest)
        {
            <h4 class="c-SectionTitle">Location</h4>
            if (booking.StateProvinceCode != null)
            {
            <div class="location">
                @LcHelpers.PrintAddress(address, false)

                <!--<a target="_blank" class="view-directions" href="http://maps.google.com/?q=@LcHelpers.GetLocationForGoogleMaps(booking)">View directions</a>-->
                @LcHelpers.PrintGoogleLink(LcHelpers.GetLocationForGoogleMaps(booking))
            </div>
            }
            else
            {
                // Null, no location
                <div>Please contact your provider for location details.</div>
            }
        }

        <h4 class="c-SectionTitle">@(myUserType == LcData.UserInfo.UserType.Provider ? "My" : itsUserData.FirstName + "'s") cancellation policy</h4>
        <div class="cancellation-policy">
            @RenderPage("$CancellationPolicyInfoWidget.cshtml", new
            {
                CancellationPolicyID = booking.CancellationPolicyID,
                DisplayForUserType = myUserType.ToString(),
                BookingDate = bookingDate,
                DisplayedCustomerName = LcData.UserInfo.GetUserRow(booking.CustomerUserID).FirstName
            })
        </div>

        <h4 class="c-SectionTitle">Reminders</h4>
        @RenderPage("$BookingRemindersWidget.cshtml", myUserType)

        <h4 class="c-SectionTitle">Need help</h4>
        @RenderPage("$NeedHelpFooterWidget.cshtml", new {
            BookingRequestID = booking.BookingRequestID,
            BookingID = isRequest ? null : booking.BookingID
        })
    </div>
}
</div>