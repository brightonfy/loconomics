@using WebMatrix.Data;
@{
    LcHelpers.SecurePage();
    
    var u = LcData.UserInfo.GetUserRow();
    int brID = PageData["BookingRequestID"] ?? Request["BookingRequestID"].AsInt();
    string redirectUrl = PageData["RedirectUrl"];
    
    var sqlCheckBookingRequest = @"
        SELECT  TOP 1 R.BookingRequestID
        FROM    BookingRequest As R
        WHERE   R.ProviderUserID = @0
                 AND
                R.BookingRequestID = @1
                -- Not Confirmed Booking Request
                 AND
                R.BookingRequestStatusID <> 7
    ";
    
    using (var db = Database.Open("sqlloco")) {
        var checkID = db.QueryValue(sqlCheckBookingRequest, u.UserID, brID);
        if (checkID != null && (int)checkID == brID) {

            var result = LcData.Booking.InvalidateBookingRequest(brID, 5); // 5:denied/declined

            if (result.Error == 0) {
                // Send message
                LcMessaging.SendBookingRequestDenegation(brID, true);
                
                if (redirectUrl == null) {
                    redirectUrl = LcUrl.LangPath + (
                        Request.IsAjaxRequest() ?
                        "Booking/$BookingDetailsWidget/?BookingRequestID={0}" :
                        "dashboard/messages/bookingrequest/{0}/");
                }
                redirectUrl = String.Format(redirectUrl, brID);
                
                if (Request.IsAjaxRequest()){
                    // An ajax redirect is performed to return the updated BookingRequestDetails html to the user
                    LcHelpers.ReturnJsonResult(3, redirectUrl);
                } else {
                    Response.Redirect(redirectUrl);
                }
            } else {
                
                var fullmsg = "We're having problems completing your request.  Please e-mail support@loconomics.com and reference: " + result.ErrorMessage;
                
                if (PageData["UseRenderReturns"]) {
                    LcHelpers.RenderPageReturns = fullmsg;
                    return;
                }
                
                if (Request.IsAjaxRequest()){
                    // Return JSON result:
                    // We need negative numbers to indicate an error (is our convention for json 'Code')
                    LcHelpers.ReturnJsonError(0 - result.Error, fullmsg);
                } else {
                    throw new HttpException(500, fullmsg);
                }
            }
        } else {
            
            // At this point, the request:
            // - Is already confirmed, cannot be declined
            // - Or it doesn't exists
            // - Or user is not the provider on that request
            // Anyway, redirect to the booking, there the user can see:
            // - That the booking was confirmed, so cannot be declined
            // - A concrete error if it doesn't exists
            // - A forbiding page if its not the provider or customer
            
            var url = LcUrl.LangPath + String.Format("dashboard/messages/bookingrequest/{0}/", brID);
            
            if (Request.IsAjaxRequest()){
                LcHelpers.ReturnJsonResult(1, url);
            } else {
                Response.Redirect(url);
            }
        }
    }
}