@{
    LcHelpers.SecurePage();
    
    var u = LcData.UserInfo.GetUserRow();
    
    Layout = "../_SiteLayout.cshtml";
    Page.Title = "Congratulations!";
    
    var bookingRequestID = Session["BookingRequestID"] is int ? (int)Session["BookingRequestID"] : 0;
    var bookingID = Session["BookingID"] is int ? (int)Session["BookingID"] : 0;
    if (bookingRequestID <= 0) {
        Response.Redirect(LcUrl.LangPath);
    }
    
    // Destroy booking session
    Session["BookingRequestID"] = null;
    Session["BookingID"] = null;
    try{
        ((Dictionary<int, object>)Session["BookingRequests"]).Remove(bookingRequestID);
    } catch { }

    // Get booking data
    dynamic booking = null;
    if (bookingID > 0) {
        booking = LcData.Booking.GetBookingForUser(bookingID, u.UserID, u.IsAdmin);
    }
    else {
        booking = LcData.Booking.GetBookingRequestForUser(bookingRequestID, u.UserID, u.IsAdmin);
    }
    var provider = LcData.UserInfo.GetUserRow(booking.ProviderUserID);
    var summary = LcData.Booking.GetBookingRequestForUser(booking.BookingRequestID, u.UserID, u.IsAdmin);
    var pricingSummary = LcData.Booking.GetPricingSummary(summary);
    //var pricingSummaryGroups = LcData.Booking.GetPricingSummaryGroups(summary.PricingEstimateID, summary);
    var pricingSummaryDetails = LcData.Booking.GetPricingSummaryDetails(summary.PricingEstimateID, summary.PricingEstimateRevision);
    
    LcAssets.AddStyle(LcUrl.AppPath + "Styles/Booking.css");
    LcAssets.AddStyle(LcUrl.AppPath + "Styles/Search.css");
}

  <div id="container" class="clearfix booking editable">
    <div id="main" class="tabbed wizard fancy">
		<h1 class="withsub">@Page.Title</h1>
        <p class="subh1">
            @if (booking.InstantBooking) {
                <text>Your appointment is all set.</text>
            }
            else {
                <text>Your appointment is in the works.</text>
            }
        </p>

        @RenderPage(LcUrl.RenderLangPath + "Profile/$UserInfoWidget.cshtml", new Dictionary<string, object>{ 
            {"Data", provider},
            {"DataPrefix", ""},
            {"Size", "mini-position"},
            {"UserType", "provider"},
            {"WithContactData", false},
            {"WithLinkInName", true},
            {"PositionData", LcData.UserInfo.GetUserPos(booking.ProviderUserID, booking.PositionID)}
        })

        <article class="booking-confirmation">
            <h2>Your order summary</h2>

            <section class="pricing">
                <h3>Pricing estimate</h3>
                @LcPricingView.CustomerPricingSummaryDetailed(pricingSummary, pricingSummaryDetails)
            </section>
            <section class="scheduling">
                @if (booking.InstantBooking)
                {
                    <h3>Your confirmed appointment time:</h3>
                    <div class="w-BookingRequestedTimes-date">
                        @LcHelpers.DateTimeRangeToString(booking.ConfirmedDateStart, booking.ConfirmedDateEnd)
                    </div>
                }
                else
                {
                    <h3>Time preferences</h3>
                    @RenderPage("$BookingRequestedTimes.cshtml", new
                       {
                           BookingData = booking,
                           MyUserType = LcData.UserInfo.UserType.Customer
                       }
                    )
                }
            </section>
            <section class="payment">
                <h3>Payment</h3>
                <p>
                    Your card ending in @LcEncryptor.Decrypt(booking.PaymentCustomerCardLastDigits) has been authorized for @booking.TotalPrice.ToString("c").
                    @if (!booking.InstantBooking) {
                        <text>
                            If your request is accepted (within 18 hours), we’ll charge your card the day @provider.FirstName performs the scheduled services.
                            If he’s unable to accept one of these times, your card will not be charged.
                        </text>
                    }
                    else {
                        <text>
                            We’ll charge your card the day @provider.FirstName performs the scheduled services.
                        </text>
                    }                    
                </p>
            </section>
            <section class="last-note">
                @if (!booking.InstantBooking)
                {
                    <h3>Next steps</h3>
                    <p>You’re probably wondering what’s next. <strong>@provider.FirstName</strong> has 18 hours to confirm one of your three appointment times.
                    We’ll then follow-up with his contact information.
                    </p>
                }
                <p>
                At your service,<br />
                <span class="sign">The Loconomics Team</span>
                </p>
            </section>
            <section class="help">
                <h3>Need Help?</h3>
                @RenderPage("$NeedHelpFooterWidget.cshtml", new {
                    BookingRequestID = booking.BookingRequestID
                })
            </section>
        </article>

    </div>
  </div>
