@using WebMatrix.Data;
@{
    dynamic booking = PageData[0];
    string myUserType = PageData[1];
    bool isRequest = PageData[2] ?? false;
    bool showPayment = PageData[3] ?? true;
    bool showPricing = PageData[4] ?? true;
    bool showCancellationPolicy = PageData[5] ?? true;
    var BookingDate = PageData["BookingDate"];
    
    if (booking == null || booking["BookingRequestID"] == null) {
        throw new Exception("No data to bound RequestedBookingServices");
    }
    
    var myUserID = (myUserType == "customer" ? booking.CustomerUserID : myUserType == "provider" ? booking.ProviderUserID : 0);
    
    dynamic summary = LcData.Booking.GetBookingRequestForUser(booking.BookingRequestID, myUserID, false);
    var pricingSummary = LcData.Booking.GetPricingSummary(summary);
    //var pricingSummaryGroups = LcData.Booking.GetPricingSummaryGroups(summary.PricingEstimateID, summary);
    var rpricingSummaryDetails = LcData.Booking.GetPricingSummaryDetails(summary.PricingEstimateID, summary.PricingEstimateRevision);
    
    // Packages and add-ons are included in pricing summary now
    //string strPackAddons = LcData.Booking.GetBookingRequestPackages(booking.BookingRequestID, booking.PricingEstimateID);
}
@helper printQuantityIfNeeded(string q){
    decimal quantity = 0;
    decimal.TryParse(q, out quantity);
    if (quantity > 1) {
        @("(" + quantity.ToString() + " items)")
    }
}
    <div style="@LcEmailTemplateHelper.StyleMessageSection()">

        @if (showPayment)
        {
            <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Payment:</h5>
            <div>
                @LcData.Booking.GetBookingPaymentInformation(booking, LcData.UserInfo.ParseUserType(myUserType))
            </div>
        }


        @if (showPricing)
        {
            <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Pricing summary:</h5>
            if (booking.BookingRequestStatusID == 4 ||
                booking.BookingID > 0 && booking.BookingStatusID == 6)
            {
                // Is a cancelled booking/request
                if (myUserType == "provider")
                {
                    @LcPricingView.EmailProviderCancellationPricingSummary(booking)
                }
                else if (myUserType == "customer")
                {
                    @LcPricingView.EmailCustomerCancellationPricingSummary(booking)
                }
            }
            else
            {
                if (myUserType == "provider")
                {
                    @LcPricingView.EmailProviderPricingSummaryDetailed(pricingSummary, rpricingSummaryDetails)
                }
                else if (myUserType == "customer")
                {
                    @LcPricingView.EmailCustomerPricingSummaryDetailed(pricingSummary, rpricingSummaryDetails)
                }
            }
        }
        
        @* Packages and add-ons are included in pricing summary now
        if (!String.IsNullOrEmpty(strPackAddons))
        {
            <div class="packages">
                @strPackAddons
            </div>
        }*@     

        @if (!String.IsNullOrEmpty(booking.SpecialRequests))
        {
            <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Special instructions:</h5>
            <p @LcEmailTemplateHelper.StyleResetP()>@booking.SpecialRequests</p>
        }
        else
        {
            <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Special instructions:</h5>
            <p @LcEmailTemplateHelper.StyleResetP()>None</p>
        }
        @if (isRequest)
        {
        <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Location and contact information:</h5>
        <div>
            <p>
            Full location and contact information will be shown after the appointment is confirmed.
            </p>
        </div>
        }

        @if (showCancellationPolicy)
        {
            <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Cancellation policy</h5>
            <div>
               @RenderPage("$CancellationPolicyInfoWidget.cshtml", new
               {
                   CancellationPolicyID = booking.CancellationPolicyID,
                   DisplayForUserType = myUserType,
                   BookingDate = BookingDate,
                   DisplayedCustomerName = LcData.UserInfo.GetUserRow(booking.CustomerUserID).FirstName
               })
            </div>
        }
    </div>
