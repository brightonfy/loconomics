@* Email with updated information about a (confirmed) Booking, mainly to communicate to the
    customer that a request was confirmed (BookingtatusID:1, but also generate content for other statuses)
 *@
@using WebMatrix.Data;
@{
    LcMessaging.SecureTemplate();
    
    Layout = LcUrl.RenderLangPath + "_EmailLayout.cshtml";

    // All the data for this email:
    var info = LcEmailTemplateHelper.GetBookingInfo();

    // Data for the EmailLayout:
    PageData["ViewOnSiteURL"] = info.ViewOnSiteURL;
    PageData["messageTitle"] = LcData.Booking.GetBookingTitleFor(info.Booking.BookingStatusID, info.PairUser, info.SentTo);
    PageData["messageSubtitle"] = LcEmailTemplateHelper.GetLastUpdateText(info.Booking.UpdatedDate);
    PageData["showSign"] = true;
    PageData["helpReference"] = "booking #" + info.BookingID.ToString();
    switch (info.SentTo) {
        case LcData.UserInfo.UserType.Provider:
            PageData["needHelpAddress"] = "providersupport@loconomics.com";
            break;
        case LcData.UserInfo.UserType.Customer:
            PageData["needHelpAddress"] = "support@loconomics.com";
            break;
    }
}
@helper printConfirmedDate(LcEmailTemplateHelper.BookingEmailInfo info){
    if (info.Booking.ConfirmedDateStart is DateTime && info.Booking.ConfirmedDateEnd is DateTime)
    {
        <span>@LcHelpers.DateTimeRangeToString(info.Booking.ConfirmedDateStart, info.Booking.ConfirmedDateEnd)</span>
    }
    else
    {
        // Null values:
        <span>Date not available</span>
    }
}
<div>
    <p>
        Hello again, @(info.SentToUser.FirstName)!
    </p>
    @* For booking confirmation, attach message about the good news!
     *@
    @if (info.Booking.BookingStatusID == 1)
    {
        switch ((LcData.UserInfo.UserType)info.SentTo)
        {
             case LcData.UserInfo.UserType.Customer:
                <p>
                    Contratulations, you're all set for @LcEmailTemplateHelper.PrintUserProfileLink(info.ProviderUser)'s <strong>@info.Booking.PositionSingular</strong>
                    services to be performed on <strong>@printConfirmedDate(info)</strong>.
                </p>
                break;
             case LcData.UserInfo.UserType.Provider:
                <p>
                    Contratulations, you're all set to perform <strong>@info.Booking.PositionSingular</strong> services for @LcEmailTemplateHelper.PrintUserProfileLink(info.CustomerUser)
                    on <strong>@printConfirmedDate(info)</strong>.
                </p>
                break;
        }
    }

    @* When booking is not cancelled and service date is passed, show Review options:
     *@
    @if (info.Booking.BookingStatusID < 6 && DateTime.Now > info.Booking.ConfirmedDateEnd)
    {
    <div style="float: right;">
        @switch ((LcData.UserInfo.UserType)info.SentTo)
        {
            // What the user see if is the Customer in the booking
            case LcData.UserInfo.UserType.Customer:
                <a class="respond" style="@LcEmailTemplateHelper.StyleRespondButton()" href="@PageData["viewOnSiteUrl"]" target="_blank">
                    @(info.Booking.ReviewedByCustomer == true ? "View my review" : "Review provider")
                </a>
                if (info.Booking.ReviewedByProvider == true) {
                <a class="respond" style="@LcEmailTemplateHelper.StyleRespondButton()" href="@PageData["viewOnSiteUrl"]" target="_blank">
                    View provider review
                </a>
                }
                break;

            // What the user see if is the Provider in the booking
            case LcData.UserInfo.UserType.Provider:
                <a class="respond" style="@LcEmailTemplateHelper.StyleRespondButton()" href="@PageData["viewOnSiteUrl"]" target="_blank">
                    @(info.Booking.ReviewedByProvider == true ? "View my review" : "Review customer")
                </a>
                if (info.Booking.ReviewedByCustomer == true) {
                <a class="respond" style="@LcEmailTemplateHelper.StyleRespondButton()" href="@PageData["viewOnSiteUrl"]" target="_blank">
                    View customer review
                </a>
                }
                break;
        }
    </div>
    }

    @if (info.Booking.BookingStatusID != 1)
    {
        <h4 @LcEmailTemplateHelper.StyleH4("color: #8B2143;")>@info.PairUserType information</h4>
        @RenderPage(LcUrl.RenderLangPath + "Email/$EmailUserInfoWidget.cshtml", new Dictionary<string, object>{ 
            {"AddContainerStyle", LcEmailTemplateHelper.StyleMessageSection()},        
            {"Data", info.PairUser},
            {"DataPrefix", ""},
            {"Size", "medium"},
            {"UserType", info.PairUserType.ToString().ToLower()}
        })
    }

    <h4 @LcEmailTemplateHelper.StyleH4("color: #8B2143;")>Booking time and location</h4>
    <div style="@LcEmailTemplateHelper.StyleMessageSection()">
        <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Position: </h5>
        <span>@info.Booking.PositionSingular</span>

        <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Scheduled time: </h5>
        @printConfirmedDate(info)

        <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>Location: </h5>
        @LcEmailTemplateHelper.PrintAddressLine(info.Booking)

        <h5 @LcEmailTemplateHelper.StyleH5("font-size: 1.1em;margin: 8px 0 0;color: #6c6c6c;")>@(info.PairUser.FirstName)'s contact information:</h5>
        @LcEmailTemplateHelper.PrintUserContactInformation(info.PairUserID)

    </div>

    <h4 @LcEmailTemplateHelper.StyleH4("color: #8B2143;")>Requested services and pricing estimate</h4>
    @{ PageData["BookingDate"] = info.Booking.ConfirmedDateStart; }
    @RenderPage("$EmailRequestedBookingServicesWidget.cshtml", info.Booking, info.SentTo.ToString().ToLower())

    <h4 @LcEmailTemplateHelper.StyleH4("color: #8B2143;")>Reminders</h4>
    @RenderPage("$EmailBookingRemindersWidget.cshtml", info.SentTo.ToString().ToLower())

    <p>
        If you need to make any changes to this booking, please <a href="@info.ViewOnSiteURL">login</a> and you can do so from your dashboard.
    </p>
</div>
