@*
    Background checks are implemented as a CRUDL-edit form that only allows inserts
    (requesting a background check), listing the available background checks for the user depending
    on its positions.

    The way to get access to this form is through the Verifications page as a unique button to add
    a background check.
    The $VericiationsList will have access to the list of background checks requested and its status.
*@
@using WebMatrix.Data;
@{
    LcHelpers.ProviderPage();

    var isSubform = PageData["IsSubform"] ?? Request["subform"].AsBool();
    
    // Current user data
    var u = LcData.UserInfo.GetUserRowWithContactData();
    
    var idprefix = "background-check-edit";
    
    var backgroundCheckId = Request["BackgroundCheckID"].AsInt();

    /*if (Validation.GetHtml("agree") == null) {
        Validation.RequireField("agree", "You must agree to the terms and conditions");
    }*/
    // Manual validation of 'agree' field because Validation.RequireField is failing
    if (IsPost && Request["agree"].IsEmpty()){
        if (Request.IsAjaxRequest()) {
            LcHelpers.ReturnJsonResult(8, new { Errors = new { agree = "You must agree to the terms and conditions" } });
        } else {
            ModelState.AddError("agree", "You must agree to the terms and conditions");
        }
    }
    
    if (IsPost && backgroundCheckId < 1) {
        if (Request.IsAjaxRequest()) {
            LcHelpers.ReturnJsonResult(8, new { Errors = new { form = "Please choose a background check" } });
        } else {
            ModelState.AddFormError("Please choose a background check");
        }
    }
    
    if (IsPost && ModelState.IsValid) {
        try {
            LcData.RequestBackgroundCheck(u.UserID, backgroundCheckId);
        } catch (Exception ex) {
            LcHelpers.ReturnJsonResult(0, "There was an error, maybe your request was already processed please review the verifications list");
        }
        
        if (ModelState.IsValid) {
            LcHelpers.ReturnJsonResult(110, "");
        }
        // All was fine, AJAX-JSON response
        //if (ModelState.IsValid) {
        //    LcHelpers.ReturnJsonResult(5, LcRessources.ShortDataSaved);
        //}
    }
    
    var checks = LcData.GetUserBackgroundChecks(u.UserID, u.CountryID, u.StateProvinceID, false);

    var formAction = LcUrl.LangPath + "$dashboard/AboutYou/$BackgroundCheckEdit/";
}
<div class="DashboardBackgroundCheck">
    <p class="setting-instructions">
        We’ve partnered with HireRight, a leading background screening company, to give you the ability to purchase and complete a background check. Background checks can be essential for some clients to feel at ease hiring your services, especially those may include children or the elderly.  Please select one of the options below, and HireRight will contact you directly via e-mail to complete the payment and process.  
    </p>

    <ul>
    @foreach (var check in checks)
    {
        <li class="DashboardBackgroundCheck-item">
            <div class="actions"><a href="#buy-check" data-background-check-id="@check.BackgroundCheckID" class="button main-action buy-action">Purchase for @check.BackgroundCheckPrice.ToString("c")</a></div>
            <h5>@check.BackgroundCheckName</h5>
            <div>
                @LcHelpers.PrintTextAsHtml(check.BackgroundCheckDescription)
            </div>
        </li>
    }
    </ul>

    <p></p>
    <div class="actions">
        <button type="button" class="button cancel-action crudl-cancel">Close</button>
    </div>

    <div class="popups">
        <div class="popup buy-step-1">
            <p>Use of background check services is voluntary. If you opt to use or access information provided by a background check service offered through the Marketplace, you agree that Loconomics offers this background check service as a convenience and does not have control over or assume any responsibility for the quality, accuracy, or reliability of the background check service or the information provided by the background check service. </p>
            <p>If you are a Service Provider and you opt to purchase background check services in connection with your Services: (i) you affirm that all of the information you provide to Loconomics in connection with the background check services is correct, complete, and applicable; (ii) you understand that you will be required to complete and sign a disclosure and consent form, which will have additional terms applicable to the background check services; (iii) you agree that Loconomics may obtain a report from HireRight that may contain information on your criminal history, address history, character, general reputation, personal characteristics, and mode of living; (iv) you agree that Loconomics may release the results of this report in connection with transactions on the Marketplace; (v) you understand that the information in the report may factor into other parties’ decisions to engage your services; (vi) you agree that Loconomics may review the information provided by the background check service and retains the right to terminate your membership based on the information; (vii) if you disagree with the contents of the report, or wish to stop the release of the results of the report, you must delete your profile; and (viii) you agree to indemnify and hold harmless Loconomics from any loss or liability that may result from the creation or release of the report.</p>
            
            @if (isSubform) {
                @Html.Raw("<")<text>fieldset data-ajax-fieldset-action="@(formAction)?subform=true" class="crudl-form ajax ajax-box DashboardBackgroundCheck-requestForm"></text>
            } else {
                @Html.Raw("<")<text>form action="@formAction" method="post" class="crudl-form ajax ajax-box DashboardBackgroundCheck-requestForm"></text>
            }
                <input type="hidden" name="BackgroundCheckID" value="@Request["BackgroundCheckID"]" />
                @Html.ValidationSummary()
                <label class="agree"><input type="checkbox" required name="agree" value="true" @Validation.GetHtml("agree") /> I agree to the terms and conditions above</label>
                <fieldset class="actions">
                    <button type="button" class="button cancel-action close-popup-action close-action">Cancel</button>
                    <input type="submit" class="button main-action @(isSubform ? "ajax-fieldset-submit" : "")" name="main-action" value="@(Request["main-action"] ?? "Purchase for $$")" />
                </fieldset>
            @if(isSubform) {
                @Html.Raw("</fieldset>")
            } else {
                @Html.Raw("</form>")
            }
        </div>
        <div class="popup buy-step-2">
            <h3>Next Steps:</h3>
            <ol>
                <li><span>Check your email</span>
                    <div class="step-details">
                        You will receive an e-mail in the next 24-48 hours from HireRight.  This message describes how to access their secure website to provide the information that will expedite your verification. 
                    </div>
                </li>
                <li><span>Complete payment and application</span>
                    <div class="step-details">
                        We’ve negotiated discounted rates with HireRight to keep the cost of obtaining a background check as low as possible.  
                        Pay HireRight directly for the background check--Loconomics does not make commission from this transaction.  Please 
                        carefully follow all instructions and  accurately enter the data as required. Also, please respond quickly to HireRight 
                        requests for more information.
                    </div>
                </li>
                <li><span>You're done</span>
                    <div class="step-details">
                        Loconomics will review your background check.  If the results are not 100% clear, we will contact you to ask permission 
                        to post to your profile.  If you choose not to post the information on your profile, you will be required to remove your profile
                        permanently.  
                    </div>
                </li>
            </ol>
            <div class="actions"><button type="button" class="button main-action close-popup-action close-action">Okay!</button></div>
        </div>
    </div>
</div>