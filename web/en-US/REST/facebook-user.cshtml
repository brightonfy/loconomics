@*
    Retrieve the user info for the logged Facebook Account.
    Methods supported:
    - GET: get a 'user' object with properties userID, email, isProvider, firstName, postalCode; parameters
        - facebook_id:long The Facebook ID related to an existing User Account that will be retrieved
        - signed_request:string The Facebook Signed Request from a succesfull client side user login,
            or alternative to this the Facebook login cookie for this App ('fbsr_*') with the signed request.
            This parameter includes the Facebook user ID and confirmation of a successul login (to avoid
            expose publicly private data through the facebook_id parameter) so the facebook_id is just
            to double check that the explicit requested user account matches the logged user.
*@
@{   
    dynamic result = new Dictionary<string, dynamic>();
    
    try {
        if (Request.HttpMethod == "GET") {
            
            var fid = Request["facebook_id"].AsLong(0);
            var fuser = LcFacebook.GetUserFromCurrentRequest();
            var fuserid = fuser != null ? ((string)fuser["id"] ?? "0").AsLong(0) : 0;
            dynamic userInfo = null;

            if (fid > 0 && fuserid == fid) {
                var userID = LcAuth.GetFacebookUserID(fid);
                if (userID.HasValue) {
                    userInfo = LcData.UserInfo.GetUserRowWithContactData(userID.Value);
                }
            }
            
            if (userInfo == null) {
                throw new HttpException(404, "User doesn't exists");
            }
            else {
                result["user"] = new {
                    userID = userInfo.UserID,
                    email = userInfo.Email,
                    isProvider = userInfo.isProvider,
                    firstName = userInfo.FirstName,
                    postalCode = userInfo.PostalCode
                };
            }
        }
        else {
            throw new HttpException(405, "Method is not allowed");
        }
    } catch(HttpException http) {
        
        Response.StatusCode = http.GetHttpCode();
        
        result["errorMessage"] = http.Message;
        if (!ModelState.IsValid) {
            result["errors"] = ModelState.Errors();
        }
        
    } catch(Exception ex){

        result["errorMessage"] = ex.Message;
    }
    
    
    // Output data
    LcHelpers.ReturnJson(result);
}