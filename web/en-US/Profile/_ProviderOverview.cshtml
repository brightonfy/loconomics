@using WebMatrix.Data;
@{
    // Current provider data record:
    var p = LcData.UserInfo.GetRequestedUserRow();
    // Current position data record:
    var pos = PageData["position"];
    // Current position number/index
    var n = pos.PositionID;
    
    dynamic posRatings;
    var dataCats = LcData.GetServiceCatsAndItsAttributes(pos.PositionID, "without-special-cats only-user-checked", pos.UserID);
    
    using (var db = Database.Open("sqlloco")) {
        posRatings = db.QuerySingle(@"
            SELECT	@0 As ProviderUserID, @1 As PositionID,
                    avg(Rating1) As Rating1,
		            avg(Rating2) As Rating2,
		            avg(Rating3) As Rating3,
                    123 As Hours
            FROM	UserReviews
            WHERE	ProviderUserID = @0
		             AND
		            PositionID = @1
        ", p["UserID"], pos["PositionID"]);
    }
}
@helper printAttributes(int catId, dynamic atts){
    <ul class="attributes-list">
        @foreach(var att in atts){
            string title, desc;
            desc = att["ServiceAttributeDescription"];
            if (String.IsNullOrWhiteSpace(desc)) {
                desc = title = "";
            } else {
                title = att["ServiceAttribute"];
            }
            <li title="@title" class="has-popup-tooltip" data-description="@desc" class="positionservices-category[@(catId)]-attribute[@(att.ServiceAttributeID)]">@att.ServiceAttribute</li>
        }
    </ul>
}
<p class="profile-intro">
    @LcHelpers.PrintTextAsHtml(pos.PositionIntro)
</p>
@*LcHelpers.SetupStarRatingPlugin()*@
@RenderPage(LcUrl.RenderLangPath + "Reviews/$UserRatingSummaryWidget.cshtml", new { ReviewedID = p.UserID, PositionID = pos.PositionID })
@RenderPage(LcUrl.RenderLangPath + "Reviews/$FeaturedReview.cshtml", new { ReviewedID = p.UserID, PositionID = pos.PositionID })

<div class="service-attribute-category">

    <div class="service-attribute-categories">
        @foreach (var cat in dataCats)
        {
            if (!LcData.SpecialServicesAttCats.Contains(cat.Key) && cat.Value["SideBarCategory"] == false)
            {
                if (cat.Value["ServiceAttributes"].Count > 0)
                {
                    string title, desc;
                    desc = cat.Value["ServiceAttributeCategoryDescription"];
                    if (String.IsNullOrWhiteSpace(desc)) {
                        desc = title = "";
                    } else {
                        title = cat.Value["ServiceAttributeCategoryName"];
                    }
                    <div class="have-view-more">
                        <h5 data-description="@desc" class="has-popup-tooltip" title="@title">@cat.Value["ServiceAttributeCategoryName"]:</h5>
                        @if (!String.IsNullOrWhiteSpace(desc))
                        {<a class="tooltip-button button view-more" href="#" data-description="@desc" title="@title">More</a>}
                        @printAttributes(cat.Key, cat.Value["ServiceAttributes"])
                        <!--<a class="view-more" href="#">View more</a>-->
                    </div>
                }
            }
        }
    </div>
</div>
