@using System.Drawing.Imaging;
@{
    const int fixedSizeWidth = 112;
    const int fixedSizeHeight = 118;
    var sizeName = fixedSizeWidth.ToString() + "x" + fixedSizeHeight.ToString();
    // To fix #558, because the change of size (so file name changed too), we do double try
    // for a while
    // TODO FUTURE: When there are no more oldSize (or a few, convert it manually), remove this and its use
    const string oldSizeName = "176x184";
    
    var userId = Request["UserID"].AsInt();
    if (userId == 0) {
        userId = UrlData[0].AsInt();
    }
    var userPhoto = "avatar.jpg";
    dynamic ur = null;
    
    if (userId == 0){
        // Get databse user information
        ur = LcData.UserInfo.GetUserRow();
    } else {
        // Get databse user information
        ur = LcData.UserInfo.GetUserRow(userId);
    }

    var type = "";    
    if (UrlData.Count > 1) {
        type = UrlData[1];
    }
    if (type == "2x") {
        type = "@2x";
    } else if (!String.IsNullOrWhiteSpace(type)) {
        type = "-" + type;
    }
    
    if (ur != null){
        userId = ur["UserID"];
        // Getting user avatar photo
        userPhoto = ur["Photo"];
    } else {
        userId = 0;
    }
    
    string userFolder = "img/userphotos/u" + userId.ToString() + "/";
    // Physical image path to userPhoto
    string path = HttpContext.Current.Request.MapPath(LcUrl.RenderAppPath + userFolder + userPhoto);
    
    bool imageAdapted = false;
    
    if (userPhoto == "$avatar") {
        // Standard name of pre-adapted image, just
        // serve ever the profile adapted photo for now instead the big colored original:
        userPhoto = "$avatar-" + sizeName + "-gray" + type + ".jpg";
        imageAdapted = true;
        // Update path:
        path = HttpContext.Current.Request.MapPath(LcUrl.RenderAppPath + userFolder + userPhoto);
        
        // Try the old size if it doesn't exists the new:
        if (!System.IO.File.Exists(path)) {

            // Update name and path
            userPhoto = "$avatar-" + oldSizeName + "-gray" + type + ".jpg";
            path = HttpContext.Current.Request.MapPath(LcUrl.RenderAppPath + userFolder + userPhoto);
        }
    }

    if (!System.IO.File.Exists(path)){
        imageAdapted = true;
        path = Server.MapPath(LcUrl.RenderAppPath + "img/userphotos/u0/avatar.png");
    }
    
    try {
        if (imageAdapted){
            new WebImage(path).Write();
        } else {
            // Transform image to Grayscale and profile photo size to avoid big images:
            // Is inside a using block because ensure close the image ressources and the file
            
            using (var img = LcImaging.Grayscale(LcImaging.Resize(new System.Drawing.Bitmap(path), fixedSizeWidth, fixedSizeHeight, LcImaging.SizeMode.Cover, LcImaging.AnchorPosition.Center))){
                // Telling to the browser that this is a JPG image
                Response.ContentType = "image/jpg";
                // Send the transformed image to the browser
                img.Save(Response.OutputStream, ImageFormat.Jpeg);
            }
        }
    }catch{}
}