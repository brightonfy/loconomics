@functions {

    /* General: some functions created with code from old 'provider-dashboard-profile.cshtml' file
    */

    /* Get a data row with the User information identified with 'userId' from the database
    */
    public static WebMatrix.Data.DynamicRecord GetUserRow(int userId) {

        // Commented unused vars:
        //var stringPosted = "Nothing";
        //var theDate = DateTime.Now.ToString("yyyy-MM-dd");
        
        var db = Database.Open("sqlloco");
        var sqluser = 
            //"exec GetUserDetails @0";
            // NOTE: UserID is needed!
            @"
                SELECT
                    a.UserID,
                    FirstName, 
                    LastName,
                    SecondLastName,
                    MiddleIn,
                    PostalCode,
                    Photo,
                    PreferredLanguageID,
                    PreferredCountryID,
                    ADD_Details 
                from users a 
                left join dbo.userprofilepositionadditional b 
                on a.userid = b.userid  where a.UserID = @0
            ";
        return db.QuerySingle(sqluser, userId);
    }
    /* Get a data row with the current user information from the database
    */
    public static WebMatrix.Data.DynamicRecord GetUserRow() {
        return GetUserRow(WebSecurity.CurrentUserId);
    }
    /* Get a data object with the Positions rows of the user identified with 'userId' from the database
    */
    public static object GetUserPos(int userId){
        var db = Database.Open("sqlloco");
        var sqlpositions = "select a.PositionID, case when a.Active = 0 then 'not active' else 'active' end as active, PositionSingular, a.UpdatedDate  from dbo.userprofilepositions a join  positions c on a.PositionID = c.PositionID where a.UserID = @0 and c.LanguageID = 1 and c.CountryID = 1";                    
        return db.Query(sqlpositions, userId);
    }
    /* Get a data object with the Positions rows of the current user from the database
    */
    public static object GetUserPos(){
        return GetUserPos(WebSecurity.CurrentUserId);
    }
    /* Function create with copying the code from the old 'provider-dashboard-profile.cshtml' file,
        must be used in the appropiated Dashboard page by back-end code.
      TODO: Un-used function
    */
    public static void ProcessProfileForm(){
        if(IsPost){
            var UserID = WebSecurity.CurrentUserId;
            var db = Database.Open("sqlloco");
            
            var sqlupdatephoto ="update users set Photo = @0 where UserID = @1";
            var sqlupdateabout ="update dbo.userprofilepositionadditional set ADD_Details = @0  where UserID = @1";
            WebImage photo = null;
            var newFileName = "";
            var imagePath = "";
            var imageThumbPath  = "";
            var aboutMe = Request.Form["aboutMeText"];
            photo = WebImage.GetImageFromRequest();
            db.Query(sqlupdateabout,aboutMe,UserID);
            if(photo != null){
                newFileName = Guid.NewGuid().ToString() + "_" +
                Path.GetFileName(photo.FileName);
                imagePath = @"img\" + newFileName;
                photo.Save(UrlUtil.AppPath + imagePath);
                imageThumbPath = @"img\thumbs\" + newFileName;
                photo.Resize(width: 180, height: 180, preserveAspectRatio: true,
                preventEnlarge: true);
                photo.Save(UrlUtil.AppPath + imageThumbPath);
                db.Query(sqlupdatephoto,imageThumbPath,UserID);
            }
        }
    }
    public static string CssCurrent(string a, string b){
        return (a == b ? "current" : "");
    }
}