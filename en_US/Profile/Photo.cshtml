@using System.Drawing.Imaging;
@{
    var userId = Request["UserID"].AsInt();
    if (userId == 0) {
        userId = UrlData[0].AsInt();
    }
    var userPhoto = "avatar.jpg";
    dynamic ur = null;
    
    if (userId == 0){
        // Get databse user information
        ur = LcData.UserInfo.GetUserRow();
    } else {
        // Get databse user information
        ur = LcData.UserInfo.GetUserRow(userId);
    }
    
    if (ur != null){
        userId = ur["UserID"];
        // Getting user avatar photo
        userPhoto = ur["Photo"];
    } else {
        userId = 0;
    }
    
    bool imageAdapted = false;
    
    if (userPhoto == "$avatar") {
        // Standard name of pre-adapted image, implementation uncomplete but basic, just
        // serve ever the profile adapted photo for now instead the big colored original:
        userPhoto = "$avatar-176x184-gray.jpg";
        imageAdapted = true;
    }
    
    string userFolder = "img/userphotos/u" + userId.ToString() + "/";

    // Retrieving image path
    string path = HttpContext.Current.Request.MapPath(UrlUtil.AppPath + userFolder + userPhoto);

    if (!System.IO.File.Exists(path)){
        imageAdapted = true;
        path = Server.MapPath(UrlUtil.AppPath + "img/userphotos/u0/avatar.png");
    }
    
    try{
        if (imageAdapted){
            new WebImage(path).Write();
        } else {
            // Transform image to Grayscale and profile photo size to avoid big images:
            // Is inside a using block because ensure close the image ressources and the file
            
            using (var img = LcImaging.Grayscale(LcImaging.Resize(new System.Drawing.Bitmap(path), 176, 184, LcImaging.SizeMode.Cover, LcImaging.AnchorPosition.Center))){
                // Telling to the browser that this is a JPG image
                Response.ContentType = "image/jpg";
                // Send the transformed image to the browser
                img.Save(Response.OutputStream, ImageFormat.Jpeg);
            }
        }
    }catch{}
}