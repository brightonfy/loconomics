@{     
    Layout = UrlUtil.LangPath + "_SiteLayout.cshtml";
   
    int userid = Request["userid"].AsInt();
    if (userid == 0) {
        userid = UrlData[0].AsInt();
    }
    // Preserve compability with providerid url param still:    
    if (userid == 0) {
        userid = Request["ProviderID"].AsInt();
    }
    int positionid = Request["PositionID"].AsInt();

    if (userid == 0) {
        Response.Redirect(UrlUtil.LangPath);
    }
        
    var u = DashboardFunctions.GetRequestedUserRow(userid);
    if (u == null) {
        Response.Redirect(UrlUtil.LangPath);
    }
    userid = u.UserID;
    
    dynamic posrows = null;
    if (u.IsProvider) {
        posrows = DashboardFunctions.GetUserPos(userid, true);
        
        // Check if the positionid requested exists for current user:
        var posexists = false;
        foreach(var c in posrows){
            if (c.PositionID == positionid) {
                posexists = true;
            }
        }
        if (!posexists) {
            if (!u.IsCustomer && posrows.Count > 0) {
                positionid = posrows[0].PositionID;
            } else {
                positionid = 0;
            }
        }
    } else {
        positionid = 0;
    }
    
    // Number of maximum positions displayed:
    var maxPositions = 5;
    
    Page.Title = u.FirstName;
    Scripts.Add(UrlUtil.AppPath + "Scripts/Profile.js");
    
    int n = 0, ip = 0;
}
@helper printFriend(string name, string photo){
    if (String.IsNullOrEmpty(photo)){ photo = "generic-friend-avatar.png";}
    /* Between LI and A elements must not have white spaces */
    <li><a href="@Href(UrlUtil.LangPath + "Profile/?user=" + name)"><img alt="@name" src="@Href(UrlUtil.AppPath + "img/" + photo)"/></a></li>
}
@helper printName(dynamic p){
    string l = (string)p["LastName"];
    if (l.Length > 1) { l = l.Substring(0, 1); }
    @(p["FirstName"] + " " + @l + ".")
}

<div id="container" class="profile clearfix">
    <div id="main" class="tabbed folders">

	    <div id="profileHeader" class="clearfix">
            <img id="avatar" class="profile-pic" src="@Href(UrlUtil.LangPath + "Profile/Photo/" + u["UserID"])" alt="User Photo" />
            <h1 class="profile-name">@printName(u)</h1>
		    
		    <p class="profile-desc">
                @if (!String.IsNullOrWhiteSpace(u["PublicBio"])) {
                    @u["PublicBio"]
                } else {
                    <text>User doesn't provide information about itself.</text>
                    <br />
                    <text>It's strongly recommended for all users to write a public bio.</text>
                }
            </p>
            @RenderPage("$UserVerificationsWidget.cshtml", new { UserID = userid })
            @RenderPage(UrlUtil.LangPath + "Social/_SocialNetworkingWidget.cshtml")
            @*
            @if (u.IsProvider) {
            <div class="social-connections">
                <ul>
                    @printFriend("Fernando", null)
                    @printFriend("Joshua", null)
                    @printFriend("Fernando", null)
                    @printFriend("Joshua", null)
                    @printFriend("Fernando", null)
                </ul>
                <span class="friends"><span class="quantity">14</span> of your friends have used this provider's services</span>
            </div>
            }
            *@
	    </div><!-- #profileHeader -->
        
        @if (u.IsProvider) {
		<ul class="tabs">
            @{
                n = 0;
                foreach(var c in posrows){
                    n++;
                    if (n > maxPositions) { break; }
                    ip = c.PositionID;
                    var cls = (c.PositionID == positionid ? "current" : "");
                    <li class="@cls"><a class="@cls" href="@("#position"+ip)">@c.PositionSingular</a></li>
                }
            }
            @if (n > 0 && u.IsCustomer) {
            <li class="@(positionid == 0 ? "current" : "")"><a href="#customer-overview">As Customer</a></li>
            }
		</ul><!-- .tabs -->
        }
        
        @if (u.IsProvider) {
            n = 0;
            foreach(var position in posrows){
                n++;
                if (n > maxPositions) { break; }
                var cls = (position.PositionID == positionid ? "current" : "");
                PageData["position"] = position;

                ip = position.PositionID;
                <div id="@("position"+ip)" class="tab-body fancy tabbed buttons @cls position-tab">
            
                    @RenderPage("_PositionSummary.cshtml")
                    <ul class="tabs">
                        <li class="current"><a class="button profile fanciful" href="@("#position"+ip)-overview">Overview</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-reviews">Reviews</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-mywork">My Work</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-map">Map</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-availability">Availability</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-verifications">Verifications</a></li>
                        <li><a class="button profile fanciful" href="@("#position"+ip)-message">Message</a></li>
                    </ul>

                   <div id="@("position"+ip)-overview" class="tab-body current overview">
                        @RenderPage("_ProviderOverview.cshtml")
                    </div><!-- #@("position"+ip)-overview -->
                    <div id="@("position"+ip)-reviews" class="tab-body reviews">
                        @RenderPage("_Reviews.cshtml")
                    </div><!-- #@("position"+ip)-reviews -->
                    <div id="@("position"+ip)-mywork" class="tab-body mywork">
                        @RenderPage("_MyWork.cshtml")
                    </div><!-- #@("position"+ip)-mywork -->
                    <div id="@("position"+ip)-map" class="tab-body map">
                        @RenderPage("_Map.cshtml")
                    </div><!-- #@("position"+ip)-map -->
                    <div id="@("position"+ip)-availability" class="tab-body availability">
                        @RenderPage("_Availability.cshtml")
                    </div><!-- #@("position"+ip)-availability -->
                    <div id="@("position"+ip)-verifications" class="tab-body verifications">
                        @RenderPage("_Verifications.cshtml")
                    </div><!-- #@("position"+ip)-verifications -->
                    <div id="@("position"+ip)-message" class="tab-body message">
                        @RenderPage("$Message.cshtml")
                    </div><!-- #@("position"+ip)-message -->
                    <!-- TODO Remove this element, without break the position-summary -->
                    <div class="clearfix"></div>
            
                </div><!-- #position@n -->
            }
        }
        @if (u.IsCustomer) {
            <div id="customer-overview" class="tab-body fancy customer customer-overview @(positionid == 0 ? "current" : "")">
                @RenderPage("$CustomerOverview.cshtml")
            </div><!-- #customer-overview -->
        }
        
    </div>
    
    @{ /*   "Taking out search box in profile" 
            @RenderPage("Profile/_SearchInProfile.cshtml") */   }
    
</div>