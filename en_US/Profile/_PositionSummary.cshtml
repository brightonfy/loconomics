@using WebMatrix.Data;
@{
    var p = DashboardFunctions.GetRequestedUserRow();
    var pos = PageData["position"];
    
    var dataCats = LcData.GetServiceCatsAndItsAttributes(pos.PositionID, "only-special-cats", pos.UserID);
    
    // TODO: Get Customer Type Id   
    var clienttypeid = PageData["ClientTypeID"] = 1;
        
    // Get our Pricing Type ID:
    int pricingtypeid = LcData.GetPositionPricingTypeID(pos.PositionID, clienttypeid);    
    
    var hourlyRate = 0M;
    var minimumBookingTime = 0M;
    using (var db = Database.Open("sqlloco")){
        if (pricingtypeid == 2 || pricingtypeid == 1) {
            // Get hourly rate
            hourlyRate = db.QueryValue(@"
                SELECT  HourlyRate
                FROM    ProviderHourlyRate
                WHERE   UserID = @0
                            AND
                        PositionID = @1
                            AND
                        ClientTypeID = @2
            ", p.UserID, pos.PositionID, clienttypeid) ?? 0;
        } else if (pricingtypeid == 3) {
            hourlyRate = db.QueryValue(@"
                SELECT  min(ProviderPackagePrice)
                FROM    ProviderPackage
                WHERE   ProviderUserID = @0
                         AND PositionID = @1
                         AND LanguageID = @2 AND CountryID = @3
            ", p.UserID, pos.PositionID, LcData.GetCurrentLanguageID(), LcData.GetCurrentCountryID()) ?? 0;
        }
        
        minimumBookingTime = db.QueryValue(@"
            SELECT  MinTime
            FROM    CalendarProviderAttributes
            WHERE   UserID = @0
        ", p.UserID) ?? 0;
    }
}
@helper printAttList(dynamic cat){
    <ul class="attributes-list">
        @foreach (var att in cat["ServiceAttributes"]) {
            if (att["UserChecked"]) {
            <li title="@att["ServiceAttribute"]" data-description="@att["ServiceAttributeDescription"]">@att["ServiceAttribute"]</li>
            }
        }
    </ul>
}
@helper printAttListLangs(dynamic cat, dynamic levelsCat){
    var selected = levelsCat["UserSelectedLevels"];
    var levelsIndex = levelsCat["LevelsIndex"];
    <ul class="attributes-list">
        @foreach (var att in cat["ServiceAttributes"]) {
            if (att["UserChecked"]) {
                string levelStr = null;
                if (selected.ContainsKey(att["ServiceAttributeID"])) {
                    var levelId = selected[att["ServiceAttributeID"]];
                    levelStr = levelsCat["ServiceAttributes"][levelsIndex[levelId]]["ServiceAttribute"];
                }
                <li title="@att["ServiceAttribute"]" data-description="@att["ServiceAttributeDescription"]">@att["ServiceAttribute"] @(levelStr == null ? "" : "(" + levelStr + ")")</li>
            }
        }
    </ul>
}
@helper printCatTitle(dynamic cat){
    <h5 title="@cat["ServiceAttributeCategoryName"]" data-description="@cat["ServiceAttributeCategoryDescription"]">
        @cat["ServiceAttributeCategoryName"]
    </h5>
}
            <div class="position-summary">
                <div class="actions book">
                    <a class="button book" href="@Href(UrlUtil.LangPath + "Booking/?providerid=" + p.UserID + "&positionid=" + pos.PositionID)">Book now</a>
                </div>
                <span class="hour-price">
                    <span class="price">
                        @if (pricingtypeid == 3) { <span class="price-since">from:</span> }
                        $@hourlyRate</span>@if (pricingtypeid != 3) { <text>/h</text> }
                    </span>
                <a class="calculate-price" href="@Href(UrlUtil.LangPath + "Booking/?providerid=" + p.UserID + "&positionid=" + pos.PositionID)">Calculate for your needs</a>
                
                <div class="provider-features-lists">
                    @if (dataCats.ContainsKey(LcData.ServiceAttCatIDExperienceLevel) && dataCats[LcData.ServiceAttCatIDExperienceLevel]["ServiceAttributes"].Count > 0)
                    {
                        var cat = dataCats[LcData.ServiceAttCatIDExperienceLevel];
                        <div class="experience-level">
                            @printCatTitle(cat)
                            <!--<a class="button view-more" href="#">More</a>-->
                            @printAttList(cat)
                        </div>
                    }
                    @if (dataCats.ContainsKey(LcData.ServiceAttCatIDExperience) && dataCats[LcData.ServiceAttCatIDExperience]["ServiceAttributes"].Count > 0)
                    {
                        var cat = dataCats[LcData.ServiceAttCatIDExperience];
                        <div class="years-experience">
                            @printCatTitle(cat)
                            <!--<a class="button view-more" href="#">More</a>-->
                            @printAttList(cat)
                        </div>
                    }
                    @if (minimumBookingTime > 0)
                    {
                    <div class="min-booing-time">
                        <h5>Minimum booking time:</h5>
                        <!--<a class="button view-more" href="#">More</a>-->
                        <ul class="attributes-list"><li>
                            @(minimumBookingTime) @(minimumBookingTime == 1 ? "hour" : "hours")
                            </li></ul>
                    </div>
                    }
                    @if (dataCats.ContainsKey(LcData.ServiceAttCatIDClientTypes) && dataCats[LcData.ServiceAttCatIDClientTypes]["ServiceAttributes"].Count > 0)
                    {
                        var cat = dataCats[LcData.ServiceAttCatIDClientTypes];
                        <div class="client-types">
                            @printCatTitle(cat)
                            <!--<a class="button view-more" href="#">More</a>-->
                            @printAttList(cat)
                        </div>
                    }
                    @if (dataCats.ContainsKey(LcData.ServiceAttCatIDLanguages) && dataCats[LcData.ServiceAttCatIDLanguages]["ServiceAttributes"].Count > 0)
                    {
                        var cat = dataCats[LcData.ServiceAttCatIDLanguages];
                        <div class="languages-spoken">
                            @printCatTitle(cat)
                            <!--<a class="button view-more" href="#">More</a>-->
                            @printAttListLangs(cat, dataCats[LcData.ServiceAttCatIDLanguageLevel])
                        </div>
                    }
                </div>
            </div>
