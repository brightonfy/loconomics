@* 
    Pricing Wizard, Customer View, PricingType 2:Custom
 *@
@using WebMatrix.Data;
@{
    var clienttypeid = PageData["ClientTypeID"];
    var c = PageData["customerrow"];
    var pos = PageData["positionrow"];
    dynamic pvars;

    using (var db = Database.Open("sqlloco")){
        // Get the Variables
        pvars = db.Query(@"
            SELECT *
            FROM    pricingvariable
            WHERE   CountryID=@0 AND LanguageID=@1 AND ClientTypeID=@2 AND PositionID=@3
                     AND Active = 1 AND PricingTypeID = 2
        ", 1, 1, clienttypeid, pos.PositionID);
    }
        
    var idprefix = "pricingwizard";
    float timeRequired = 0, hourPrice = 0, feePrice = 0, subtotalPrice = 0, totalPrice = 0;
    
    if (IsPost){
        if (UrlData[0].ToLower() == "calculate"){
            // Do the calculation and return the result
            
            // TODO Get hour price from database:
            hourPrice = 20F;

                        
            // Calculate time required
            timeRequired = 0;
            
            foreach (var pvar in pvars){
                string customerValue = Request[pvar.PricingVariableName];
                
                // TODO Get provider value
                string providervalue;
                
                // Testing
                timeRequired++;
            }
            
            subtotalPrice = timeRequired * hourPrice;
            feePrice = .1F * subtotalPrice;            
            totalPrice = subtotalPrice + feePrice;
            
        }else{
            // TODO Save the data into the database
            
            // All OK:
            CommonHelpers.ReturnJsonResult(0, null);
        }
    }
}
@functions{
    string[] getValuesFromCSV(string line){
        return line.Split(',');
    }
}
@helper getChecked(string name, string value){
    @Html.Raw(Request[name] == value ? "selected='selected'" : "")
}
    <ul>
    @foreach (var pvar in pvars){
        <li class="@pvar.PricingVariableName">
            <label for="@idprefix-@pvar.PricingVariableName">@pvar.CustomerPricingVariableDisplayText</label>
            @switch((string)@pvar.CustomerDataInputType){
                case "dropdown":
                    <select id="@idprefix-@pvar.PricingVariableName" name="@pvar.PricingVariableName" class="data-type-dropdown">
                        @{
                            var optvalues = getValuesFromCSV(pvar.CustomerDataValues);
                            foreach(string optv in optvalues){
                                var v = optv.Trim();
                                <option value="@v" @getChecked(pvar.PricingVariableName, v)>@v</option>
                            }
                        }
                    </select>
                    break;
                case "number":
                case "text":
                    <input type="text" id="@idprefix-@pvar.PricingVariableName" name="@pvar.PricingVariableName" value="@Request[pvar.PricingVariableName]" class="data-type-@pvar.CustomerDataInputType" />
                    break;
                default:
                    <text>Unknowed CustomerDataInputType: @pvar.CustomerDataInputType</text>
                    break;
            }
        </li>
    }

    </ul>
    <div class="calculate-price-button actions">
        <button class="button calculate-price-button ajax-fieldset-submit">Calculate</button>
    </div>
    <div class="calculation">
        <table class="calculation">
            <tr><th>Time required:</th><td class="time-required">@timeRequired hour(s)</td></tr>
            <tr>
                <th><span class="time-required">@timeRequired hour(s)</span> @@ <span class="hour-price">$@hourPrice</span></th>
                <td class="subtotal-price">$@subtotalPrice</td>
            </tr>
            <tr>
                <th>Loconomics service fee:</th>
                <td class="fee-price">$@feePrice</td>
            </tr>
            <tr>
                <th>Total price:</th>
                <td class="total-price">$@totalPrice</td>
            </tr>
        </table>
    </div>
