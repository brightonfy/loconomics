@using WebMatrix.Data;
@{
    LcHelpers.SecurePage();
    
    var u = LcData.UserInfo.GetUserRow();
    var brID = Request["BookingRequestID"].AsInt();
    var dateType = Request["ConfirmedDateType"];
    
    var sqlGetBookingDates = @"
        SELECT  TOP 1
                R.PreferredDateID,
                R.AlternativeDate1ID,
                R.AlternativeDate2ID
        FROM    BookingRequest As R
        WHERE   R.ProviderUserID = @0
                 AND
                R.BookingRequestID = @1
                -- Only bookings 'created', but not incomplete, confirmed, cancelled or any other one
                 AND
                R.BookingRequestStatusID = 2
    ";
    var sqlConfirmBooking = @"
        -- Parameters
        DECLARE @BookingRequestID int, @ConfirmedDateID int
        SET @BookingRequestID = @0
        SET @ConfirmedDateID = @1

        DECLARE @BookingID int
        SET @BookingID = -1

        BEGIN TRY
            BEGIN TRAN

            /*
             * Creating the Confirmed Booking Record
             */
            INSERT INTO Booking (
                BookingRequestID, ConfirmedDateID,
                BookingStatusID,
                TotalPricePaidByCustomer, TotalServiceFeesPaidByCustomer, 
                TotalPaidToProvider, TotalServiceFeesPaidByProvider, 
                PricingAdjustmentApplied,
                CreatedDate, UpdatedDate, ModifiedBy
            ) VALUES (
                @BookingRequestID, @ConfirmedDateID,
                1, --confirmed
                -- Initial price data to null
                -- (booking request prices are estimated, here only paid prices go)
                null, null, null, null,
                0, -- not applied price adjustement (now, almost)
                getdate(), getdate(), 'sys'
            )
            SET @BookingID = @@Identity

            -- Removing non needed CalendarEvents:
            DELETE FROM CalendarEvents
            WHERE ID IN (
                SELECT TOP 1 PreferredDateID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND PreferredDateID <> @ConfirmedDateID
                UNION
                SELECT TOP 1 AlternativeDate1ID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND AlternativeDate1ID <> @ConfirmedDateID
                UNION
                SELECT TOP 1 AlternativeDate2ID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND AlternativeDate2ID <> @ConfirmedDateID
            )

            /*
             * Update Availability of the CalendarEvent record for the ConfirmedDateID,
             * from 'tentative' to 'busy'
             */
            UPDATE  CalendarEvents
            SET     CalendarAvailabilityTypeID = 2
            WHERE   Id = @ConfirmedDateID

            /*
             * Updating Booking Request status, and removing references to the 
             * user selected dates (there is already a confirmed date in booking).
             */
            UPDATE  BookingRequest
            SET     BookingRequestStatusID = 7, -- accepted
                    PreferredDateID = null,
                    AlternativeDate1ID = null,
                    AlternativeDate2ID = null
            WHERE   BookingRequestID = @BookingRequestID

            COMMIT TRAN

            -- We return sucessful operation with Error=0
            -- and attach the BookingID created instead of an ErrorMessage
            SELECT 0 As Error, @BookingID As BookingID
        END TRY
        BEGIN CATCH
            IF @@TRANCOUNT > 0
                ROLLBACK TRAN
            -- We return error number and message
            SELECT ERROR_NUMBER() As Error, ERROR_MESSAGE() As ErrorMessage
        END CATCH
    ";
    
    using (var db = Database.Open("sqlloco")) {
        var dateID = 0;
        var dates = db.QuerySingle(sqlGetBookingDates, u.UserID, brID);
        if (dates != null) {
            switch (dateType.ToUpper()) {
                case "PREFERRED":
                    if (dates.PreferredDateID != null) {
                        dateID = dates.PreferredDateID;
                    }
                    break;
                case "ALTERNATIVE1":
                    if (dates.AlternativeDate1ID != null) {
                        dateID = dates.AlternativeDate1ID;
                    }
                    break;
                case "ALTERNATIVE2":
                    if (dates.AlternativeDate2ID != null) {
                        dateID = dates.AlternativeDate2ID;
                    }
                    break;
            }
        }
        if (dateID > 0) {
            
            var dateInfo = db.QuerySingle(@"
                SELECT  ID, StartTime, EndTime
                FROM    CalendarEvents
                WHERE   ID = @0
            ", dateID);
            var isNotAvailable = (bool)db.QueryValue("exec dbo.CheckProviderAvailability @0,@1,@2", u.UserID, dateInfo.StartTime, dateInfo.EndTime);
            
            if (isNotAvailable) {
                @OnError(brID, "availability", null, -91);
            } else {
                var result = db.QuerySingle(sqlConfirmBooking, brID, dateID);
            
                if (result.Error == 0) {
                    // Send message
                    LcMessaging.SendBookingRequestConfirmation(brID, result.BookingID, true);
                
                    if (Request.IsAjaxRequest()) {
                        LcHelpers.ReturnJsonResult(3, UrlUtil.LangPath + String.Format(
                            "Booking/$BookingDetails/?BookingRequestID={0}&BookingID={1}", brID, result.BookingID ));
                    } else {
                        Response.Redirect(UrlUtil.LangPath + String.Format(
                            "Dashboard/Bookings/#!BookingRequest-{0}_Booking-{1}", brID, result.BookingID ));
                    }
                } else {
                    // We need negative numbers to indicate an error (is our convention for json 'Code')
                    @OnError(brID, "confirm", result.ErrorMessage, 0 - result.Error);
                }
            
                // Charge total amount of booking request to the customer (Submit to settlement the transaction)
                // Get booking request TransactionID
                string tranID = N.DE(db.QueryValue(LcData.Booking.sqlGetTransactionIDFromBookingRequest, brID));
                if (!String.IsNullOrEmpty(tranID) && !tranID.StartsWith("TEST:")){
                    string paymentError = LcPayment.SettleTransaction(tranID);
                    if (paymentError != null) {
                        @OnError(brID, "payment", paymentError, -92);
                    }
                }
            }
        } else {
            /* What? 
            * - BookingRequestID and UserID (as ProviderUserID) don't match?
            * - ConfirmedDateType is not correct?
            * - BookingRequest is already confirmed?
            */
            @OnError(brID, "find", null, -90);
        }
    }
}
@** task must be: find, confirm, payment, availability
  *@
@helper OnError(int brID, string task, string errorMessage, int errorCode) {  
    string msg = "";
    switch (task) {
        case "payment":
            msg = String.Format("We're having issues with your payment.  Please contact us at support@loconomics.com and reference: {0}", errorMessage);
            break;
        case "find":
            msg = "We're having issues finding your booking request.  Please contact us at support@loconomics.com.";
            break;
        case "confirm":
            msg = string.Format("Error confirming the booking request: {0}", errorMessage);
            break;
        case "availability":
            msg = "LJDI: You are already busy for that date-time! Please confirm another date.";
            break;
    }
    if (Request.IsAjaxRequest()) {
        LcHelpers.ReturnJsonError(errorCode, errorMessage);
    } else {
        if (task != "payment") {
            Response.Redirect(
                UrlUtil.LangPath + 
                String.Format("Dashboard/Bookings/#!BookingRequest-{0}", brID));
        } else {
            throw new HttpException(500, msg);
        }
    }
}