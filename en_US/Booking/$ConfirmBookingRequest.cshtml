@using WebMatrix.Data;
@{
    CommonHelpers.SecurePage();
    
    var u = DashboardFunctions.GetUserRow();
    var brID = Request["BookingRequestID"];
    var dateType = Request["ConfirmedDateType"];
    
    var sqlGetBookingDates = @"
        SELECT  TOP 1
                R.PreferredDateID,
                R.AlternativeDate1ID,
                R.AlternativeDate2ID
        FROM    BookingRequest As R
        WHERE   R.ProviderUserID = @0
                 AND
                R.BookingRequestID = @1
                -- Not Confirmed Booking Request, to avoid repeated confirmations happen
                 AND
                R.BookingRequestStatusID <> 7
    ";
    var sqlConfirmBooking = @"
        DECLARE @BookingRequestID int, @ConfirmedDateID int
        SET @BookingRequestID = @0
        SET @ConfirmedDateID = @1

        BEGIN TRY
            BEGIN TRAN

            /*
             * Creating the Confirmed Booking Record
             */
            INSERT INTO Booking (
                BookingRequestID, ConfirmedDateID,
                BookingStatusID,
                TotalPricePaidByCustomer, TotalServiceFeesPaidByCustomer, 
                TotalPaidToProvider, TotalServiceFeesPaidByProvider, 
                PricingAdjustmentApplied,
                CreatedDate, UpdatedDate, ModifiedBy
            ) VALUES (
                @BookingRequestID, @ConfirmedDateID,
                1, --confirmed
                -- Initial price data to null
                -- (booking request prices are estimated, here only paid prices go)
                null, null, null, null,
                0, -- not applied price adjustement (now, almost)
                getdate(), getdate(), 'sys'
            )

            -- Removing non needed CalendarEvents:
            DELETE FROM CalendarEvents
            WHERE ID IN (
                SELECT TOP 1 PreferredDateID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND PreferredDateID <> @ConfirmedDateID
                UNION
                SELECT TOP 1 AlternativeDate1ID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND AlternativeDate1ID <> @ConfirmedDateID
                UNION
                SELECT TOP 1 AlternativeDate2ID FROM BookingRequest
                WHERE BookingRequestID = @BookingRequestID AND AlternativeDate2ID <> @ConfirmedDateID
            )

            /*
             * Update Availability of the CalendarEvent record for the ConfirmedDateID,
             * from 'tentative' to 'busy'
             */
            UPDATE  CalendarEvents
            SET     CalendarAvailabilityTypeID = 2
            WHERE   Id = @ConfirmedDateID

            /*
             * Updating Booking Request status, and removing references to the 
             * user selected dates (there is already a confirmed date in booking).
             */
            UPDATE  BookingRequest
            SET     BookingRequestStatusID = 7, -- accepted
                    PreferredDateID = null,
                    AlternativeDate1ID = null,
                    AlternativeDate2ID = null
            WHERE   BookingRequestID = @BookingRequestID

            COMMIT TRAN

            -- We return sucessful operation (Error=0)
            SELECT 0 As Error, '' As ErrorMessage
        END TRY
        BEGIN CATCH
            IF @@TRANCOUNT > 0
                ROLLBACK TRAN
            -- We return error number and message
            SELECT ERROR_NUMBER() As Error, ERROR_MESSAGE() As ErrorMessage
        END CATCH
    ";
    
    using (var db = Database.Open("sqlloco")) {
        var dateID = 0;
        var dates = db.QuerySingle(sqlGetBookingDates, u.UserID, brID);
        if (dates != null) {
            switch (dateType.ToUpper()) {
                case "PREFERRED":
                    dateID = dates.PreferredDateID;
                    break;
                case "ALTERNATIVE1":
                    dateID = dates.AlternativeDate1ID;
                    break;
                case "ALTERNATIVE2":
                    dateID = dates.AlternativeDate2ID;
                    break;
            }
        }
        if (dateID > 0) {
            var result = db.QuerySingle(sqlConfirmBooking, brID, dateID);
            
            // Return JSON result: If result.Error is 0, result will be 'all is fine!'
            // but is not, we need negative numbers (is our convention for json errors code)
            CommonHelpers.ReturnJsonError(0 - result.Error, result.ErrorMessage);
        } else {
            /* What? 
             * - BookingRequestID and UserID (as ProviderUserID) don't match?
             * - ConfirmedDateType is not correct?
             * - BookingRequest is already confirmed?
             */
            CommonHelpers.ReturnJsonError(-1, "Impossible to confirm that Booking Request and date. Is already confirmed?");
        }
    }
}