@using Braintree;
@using System.Configuration;
@using WebMatrix.Data;
@{
    // true to testing, false to production/use braintree
    var TESTING_EMULATEBRAINTREE = Request.Params["TESTING_EMULATEBRAINTREE"].AsBool();
    
    var p = PageData["providerrow"] ?? DashboardFunctions.GetUserRow(Request["providerid"].AsInt());
    var c = PageData["customerrow"] ?? DashboardFunctions.GetUserRow();
    var pos = PageData["positionrow"] ?? DashboardFunctions.GetUserPos(Request["providerid"].AsInt(),
        Request["positionid"].AsInt());
    //var customerid = c.UserID;
    
    if (p == null || c == null || pos == null){
        var inputdataerrormessage = "No enought input data to show results";
        if (Request.IsAjaxRequest()){
            CommonHelpers.ReturnJsonError(-1, inputdataerrormessage);
        }else{
            throw new Exception(inputdataerrormessage);
        }
    }
    
    // Check if is a valid booking process (session not expired or erro at first step)
    var bookingRequestID = Session["BookingRequestID"] is int ? (int)Session["BookingRequestID"] : 0;
    if (bookingRequestID <= 0) {
        /* Several options to do here
            * - Show error (strange message for user, need restart again introducing first his login)
            * X Silently redirect to start booking again
            * - Request login via ajax, re-send form data, looking in the database for a 'timeouted'
            *   bookingrequest for this customer at this provider and position, recover it to continue
            *   processing the form (if there is no bookingrequestid again, do second option).
            */
        //ModelState.AddFormError("Booking request is not valid, maybe the session time expired");
        CommonHelpers.ReturnJsonResult(1, 
            UrlUtil.LangPath + "Booking/?ProviderID=" + p.UserID.ToString() +
            "&PositionID=" + pos.PositionID.ToString());
    }

    /*
     * Validation
     */
    Validation.RequireField("name-on-card", "'Name as on card' is required");
    Validation.RequireField("street-address-line-1", "Street address is required");
    Validation.RequireField("city", "City is required");
    Validation.RequireField("state", "State is required");
    Validation.RequireField("zip", "Zip Postal Code is required");
    Validation.RequireField("card-number", "Card number is required");
    Validation.RequireField("card-exp-month", "Card expiration month is required");
    Validation.RequireField("card-exp-year", "Card expiration year is required");
    Validation.Add("zip", Validator.Integer("Zip postal code must be a valid number"));
    
    if (IsPost && Validation.IsValid()){
        /*
         * Complext validations
         */
        if (Request["save-payment"] == "true" && Request["save-payment-as"].IsEmpty()){
            ModelState.AddError("save-payment-as", "To save the payment is required a name");
        }
        using (var db = Database.Open("sqlloco")) {

            // Validate that Zip Postal Code is valid, and get the matching ID to be used later
            var sqlGetPostalCodeID = @"
                SELECT  PostalCodeID
                FROM    PostalCode As PC
                WHERE   PC.PostalCode = @0
                         AND
                        CountryID = @1
                         AND
                        StateProvinceID = @2
            ";
            var postalCodeID = db.QueryValue(sqlGetPostalCodeID, Request["zip"], 1, Request["state"]);
            if (postalCodeID == null) {
                ModelState.AddError("zip", "Zip Postal Code is not valid");
            }
        
            if (ModelState.IsValid){
                try {
                    /*
                     * Get data from our database about BookingRequest in order to
                     * do further operations -braintree, timezones-
                     */
                    // Get data from the BookingRequest
                    var sqlGetBookingPrice = @"
                        SELECT  TOP 1
                                P.TotalPrice,
                                B.PreferredDateID,
                                B.AlternativeDate1ID,
                                B.AlternativeDate2ID
                        FROM    BookingRequest As B
                                 INNER JOIN
                                PricingEstimate As P
                                  ON P.PricingEstimateID = B.PricingEstimateID
                        WHERE   B.CustomerUserID = @0 AND B.ProviderUserID = @1
                                 AND B.PositionID = @2 AND B.BookingRequestID = @3
                    ";
                    var BookingRequest = db.QuerySingle(sqlGetBookingPrice, c.UserID, p.UserID, pos.PositionID, bookingRequestID);
                    var TotalPrice = BookingRequest.TotalPrice;
                    
                    /*
                     * Updating events created by the user for this Booking setting the Time Zone we found 
                     * looking in our Postal Codes table.
                     */
                    var sqlGetTimeZone = @"
                        SELECT  TimeZone
                        FROM    PostalCode
                        WHERE   PostalCodeID = @0
                    ";
                    var sqlUpdCalendarEvent = @"
                        UPDATE  CalendarEvents
                        SET     TimeZone = @1
                        WHERE   Id = @0
                    ";
                    var timeZone = db.QueryValue(sqlGetTimeZone, postalCodeID);
                    db.Execute(sqlUpdCalendarEvent, BookingRequest.PreferredDateID, timeZone.ToString());
                    db.Execute(sqlUpdCalendarEvent, BookingRequest.AlternativeDate1ID, timeZone.ToString());
                    db.Execute(sqlUpdCalendarEvent, BookingRequest.AlternativeDate2ID, timeZone.ToString());
                    
                    /*
                     * Send customer payment data to Braintree, 
                     * using our UserID as identifier.
                     */
                    // User wants to save as 'my location'?
                    string paymentNickName = null;
                    if (Request["save-payment"] == "true" &&
                        !String.IsNullOrWhiteSpace(Request["save-payment-as"])) {
                        paymentNickName = Request["save-payment-as"];
                    }
                    
                    var transactionID = "";
                    
                    if (TESTING_EMULATEBRAINTREE) {
                        // TESTING, emulate Braintree generating false transactionID,
                        // avoiding comunicate with them.
                        transactionID = "TEST:" + Guid.NewGuid().ToString();
                    } else {
                        // REAL Braintree Code
                        //TODO: check for existing user id or credit card
                        BraintreeGateway gateway;
                        if (ConfigurationManager.AppSettings["Braintree.InSandbox"].AsBool()) {
                            //SandBox API keys for testing
                            gateway = new BraintreeGateway 
                            {
                                Environment = Braintree.Environment.SANDBOX,
                                MerchantId = ConfigurationManager.AppSettings["Braintree.Sandbox.MerchantId"], 
                                PublicKey = ConfigurationManager.AppSettings["Braintree.Sandbox.PublicKey"],
                                PrivateKey = ConfigurationManager.AppSettings["Braintree.Sandbox.PrivateKey"]
                            };
                        } else {
                            gateway = new BraintreeGateway
                            {
                                Environment = Braintree.Environment.PRODUCTION,
                                MerchantId = ConfigurationManager.AppSettings["Braintree.Production.MerchantId"],
                                PublicKey = ConfigurationManager.AppSettings["Braintree.Production.PublicKey"],
                                PrivateKey = ConfigurationManager.AppSettings["Braintree.Production.PrivateKey"]
                            };
                        }
                        TransactionRequest request = new TransactionRequest
                        {
                            Amount = TotalPrice,
                            CreditCard = new TransactionCreditCardRequest
                            {
                                Token = paymentNickName,
                                CardholderName = Request["name-on-card"],
                                Number = Request["card-number"],
                                ExpirationDate = Request["card-exp-month"] + Request["card-exp-year"],
                            },
                            Customer = new CustomerRequest
                            {
                                Id = c.UserID.ToString()
                            },
                            BillingAddress = new AddressRequest
                            {
                                StreetAddress = Request["street-address-line-1"],
                                ExtendedAddress = Request["street-address-line-2"],
                                Locality = Request["city"],
                                Region = Request["state"],
                                PostalCode = Request["zip"],
                                CountryCodeAlpha2 = "US"
                            },
                            Options = new TransactionOptionsRequest
                            {
                                StoreInVaultOnSuccess = true,
                                AddBillingAddressToPaymentMethod = true
                            }
                        };
                    
                        Result<Transaction> result = null;
                        try{
                            result = gateway.Transaction.Sale(request);
                        } catch{}
                    
                        // Checking results:
                        if (result == null) {
                            ModelState.AddFormError("Unexpected error during credit card verification");
                        } else if (!result.IsSuccess()) {
                            ModelState.AddFormError(result.Message);
                            foreach (var error in result.Errors.All()) {
                                ModelState.AddFormError(error.Message);
                            }
                        } else {
                            transactionID = result.Transaction.Id;
                        }
                    }
                    
                    if (ModelState.IsValid) {
                        /*
                         * Save Braintree Transaction ID in the Booking Request,
                         * and updating State to 'Booking Request Completed'
                         */
                        db.Execute(@"
                            UPDATE  BookingRequest
                            SET     PaymentTransactionID = @1,
                                    BookingRequestStatusID = 2 -- Completed
                            WHERE   BookingRequestID = @0
                        ", bookingRequestID, transactionID);
                        
                        /*
                         * Create, save and send Message
                         */
                    }
                    
                } catch (Exception ex) {
                    CommonHelpers.ReturnJsonError(-1, ex.Message);
                    if (Context.IsDebuggingEnabled) {
                        throw ex;
                    }
                }
            }
            if (ModelState.IsValid) {
                // Return OK result
                CommonHelpers.ReturnJsonResult(0, null);
            }
        }
    }
    
    /*
     * Get Data
     */
    var getBookingRequest = @"
        SELECT  TOP 1
                B.SpecialRequests, B.PricingEstimateID,
                L.AddressLine1, L.AddressLine2, L.City, L.PostalCodeID, L.CountryID,
                SP.StateProvinceName, SP.StateProvinceCode,
                E1.StartTime As PreferredDateStart, E1.EndTime As PreferredDateEnd,
                E2.StartTime As AlternativeDate1Start, E2.EndTime As AlternativeDate1End,
                E3.StartTime As AlternativeDate2Start, E3.EndTime As AlternativeDate2End,
                P.ServiceDuration, P.HourlyPrice, P.SubtotalPrice, P.FeePrice, P.TotalPrice
        FROM    BookingRequest As B
                 INNER JOIN
                ServiceAddress As L
                  ON B.ServiceAddressID = L.ServiceAddressID
                 INNER JOIN
                CalendarEvents As E1
                  ON E1.ID = B.PreferredDateID
                 INNER JOIN
                CalendarEvents As E2
                  ON E2.ID = B.AlternativeDate1ID
                 INNER JOIN
                CalendarEvents As E3
                  ON E3.ID = B.AlternativeDate2ID
                 INNER JOIN
                PricingEstimate As P
                  ON P.PricingEstimateID = B.PricingEstimateID
                 INNER JOIN
                StateProvince As SP
                  ON SP.StateProvinceID = L.StateProvinceID
        WHERE   B.CustomerUserID = @0 AND B.ProviderUserID = @1
                 AND B.PositionID = @2 AND B.BookingRequestID = @3
    ";
     var getServicesIncluded = @"
        SELECT  S.Name
        FROM    PricingEstimateDetail As P
                 INNER JOIN
                ServiceAttribute As S
                  ON S.ServiceAttributeID = P.ServiceAttributeID
        WHERE   P.PricingEstimateID = @0
                 AND S.CountryId = @1 AND S.LanguageID = @2
    ";
    var getPricingVars = @"
        SELECT  V.CustomerPricingVariableDisplayText As Name, P.CustomerPricingDataInput As Quantity
        FROM    PricingEstimateDetail As P
                 INNER JOIN
                PricingVariable As V
                  ON V.PricingVariableID = P.PricingVariableID
        WHERE   P.PricingEstimateID = @0
                 AND V.CountryId = @1 AND V.LanguageID = @2
    ";
    var getPricingOptions = @"
        SELECT  V.CustomerPricingOptionDisplayText As Name, P.CustomerPricingDataInput As Quantity
        FROM    PricingEstimateDetail As P
                 INNER JOIN
                PricingOption As V
                  ON V.PricingOptionID = P.PricingOptionID
        WHERE   P.PricingEstimateID = @0
                 AND V.CountryId = @1 AND V.LanguageID = @2
    ";
    dynamic summary, services, pvars, poptions;
    using (var db = Database.Open("sqlloco")) {
        summary     = db.QuerySingle(getBookingRequest, c.UserID, p.UserID, pos.PositionID, bookingRequestID);
        services    = db.Query(getServicesIncluded, summary.PricingEstimateID, 1, 1);
        pvars       = db.Query(getPricingVars, summary.PricingEstimateID, 1, 1);
        poptions    = db.Query(getPricingOptions, summary.PricingEstimateID, 1, 1);
    }
    // auxiliar vars in view generation
    int i = 0;
    string iprint = "";
}
<p class="info">
    Please review the summary and provide your payment details below. You will be charged immediately.  We withhold payment to your provider until after the services are performed for your safety.
</p>
<form action="@(UrlUtil.LangPath)Booking/$Payment/@Request.Url.Query" method="post" class="payment" id="booking-payment">
    <input type="hidden" name="providerid" value="@p.UserID"/>
    <input type="hidden" name="positionid" value="@pos.PositionID"/>
    @CommonHelpers.GetValidationScripts()
    @CommonHelpers.SetupStarRatingPlugin()
    @Html.ValidationSummary(LcRessources.ValidationSummaryTitle)
    <fieldset class="billing-info box">
        <legend>Billing information:</legend>
        <ul>
            <li class="name-on-card">
                <label>Name as on card:<input type="text" name="name-on-card" value="@Request["name-on-card"]" @Validation.GetHtml("name-on-card")/></label>
            </li>
            <li class="street-address-line-1">
                <label>Street address line 1:<input type="text" name="street-address-line-1" value="@Request["street-address-line-1"]" @Validation.GetHtml("street-address-line-1")/></label>
            </li>
            <li class="street-address-line-2">
                <label>Street address line 2:<input type="text" name="street-address-line-2" value="@Request["street-address-line-2"]" @Validation.GetHtml("street-address-line-2")/></label>
            </li>
            <li class="city">
                <label>City:<input type="text" name="city" value="@Request["city"]" @Validation.GetHtml("city")/></label>
            </li>
            <!-- Collapsed next elements code to avoid white spaces that create excesive width on IE -->
            <li class="state"><label>State:<select name="state" @Validation.GetHtml("state")>
                        @CommonHelpers.StateProvinceOptions(Request["state"])
                    </select></label></li>
            <li class="zip">
                <label>Zip Code:<input type="text" name="zip" value="@Request["zip"]" @Validation.GetHtml("zip")/></label>
            </li>
            <li class="card-number">
                <label>Card number:<input type="text" name="card-number" value="@Request["card-number"]" @Validation.GetHtml("card-number")/></label>
            </li>
            <!-- Collapsed next elements code to avoid white spaces that create excesive width on IE -->
            <li class="card-exp"><label>Exp:<select name="card-exp-month" @Validation.GetHtml("card-exp-month")>
                        @CommonHelpers.MonthOptions(Request["card-exp-month"])
                    </select></label><select name="card-exp-year">
                        @CommonHelpers.CardYearOptions(Request["card-exp-year"])
                    </select></li>
            <li class="save-to-my-payments">
                <label class="save"><input type="checkbox" @CommonHelpers.IsChecked(Request["save-payment"], "true") name="save-payment" value="true" />Save</label>
                <label class="save-as">payment details as:<input type="text" value="@Request["save-payment-as"]" name="save-payment-as" @Validation.GetHtml("save-payment-as")/></label>
            </li>
        </ul>
    </fieldset>
    <fieldset class="your-provider box">
        <legend>Your provider:</legend>
        <h6 class="provider-and-position"><span class="provider-name">@p.FirstName</span>-<span class="provider-position">@pos.PositionSingular</span></h6>
        <img class="avatar provider-avatar" alt="Provider photo" src="@Href(UrlUtil.LangPath + "Profile/Photo/?UserID=" + p.UserID)"/>      
        @RenderPage(UrlUtil.LangPath + "Reviews/$UserRatingSummaryWidget.cshtml", new { ReviewedID = p.UserID, PositionID = pos.PositionID })
        <div class="provider-features-lists">
            <div class="years-experience">
                <h5>Years experience:</h5>
                <ul><li>0.5 years</li></ul>
            </div>
            <div class="licenses">
                <h5>Licenses:</h5>
                <ul><li>CA License</li><li>HSA certified</li></ul>
            </div>
            <div class="experience-level">
                <h5>Experience level:</h5>
                <ul><li>Expert</li></ul>
            </div>
        </div>
    </fieldset>
    <fieldset class="services-summary box">
        <legend>Summary of services to be performed:</legend>
        <ul>
            <li class="services-list">
                <strong>Services:</strong>
                @*Sweeping, mopping, vacuuming, dusting, bed-making, dishes, trash emptying, toilets*@
                @{
                    i = 0;
                    iprint = "";
                    foreach (var service in services) {
                        if (i > 0) {
                            iprint = ", ";
                        }
                        i++;
                        @(iprint + service.Name)
                    }
                }
            </li>
            <li class="special-instructions">
                <strong>Special instructions:</strong>
                @summary.SpecialRequests
            </li>
            <li class="location">
                <strong>Location:</strong>
                @*187 Bocana St., San Francisco, CA 94110*@
                @summary.AddressLine1 @(summary.AddressLine2), @(summary.City), @summary.StateProvinceCode @summary.PostalCodeID
            </li>
            <li class="details">
                <strong>Details:</strong>
                @*Home with 3 bedrooms, 2 bathrooms, 1 kitchen, 2 living areas, and has cats.*@
                @{
                    i = 0;
                    iprint = "";
                    foreach (var pitem in pvars) {
                        if (i > 0) {
                            iprint = "; ";
                        }
                        i++;
                        @(iprint + pitem.Name + " " + @pitem.Quantity)
                    }
                    iprint = "";
                    if (pvars.Count > 0) {
                        iprint = "; ";
                    }
                    i = 0;
                    foreach (var pitem in poptions) {
                        if (i > 0) {
                            iprint = "; ";
                        }
                        i++;
                        @(iprint + pitem.Name + "" + @pitem.Quantity)
                    }
                 }
            </li>
        </ul>
        @*<div class="acti
                }ons">
            <button class="button edit">Edit</button>
        </div>*@
    </fieldset>
    <fieldset class="appt-time-price box">
        <legend>Appointment time and price:</legend>
        <div class="schedule">
            <h6>Ranked in order of preference:</h6>
            <ol>
                <li class="preferred-option">@*Monday, April 15th, 2012, 11:00am to 2:00pm*@
                    @(summary.PreferredDateStart.ToLongDateString()),
                    @summary.PreferredDateStart.ToShortTimeString() to
                    @summary.PreferredDateEnd.ToShortTimeString()
                </li>
                <li class="alternative-option-1">
                    @(summary.AlternativeDate1Start.ToLongDateString()),
                    @summary.AlternativeDate1Start.ToShortTimeString() to
                    @summary.AlternativeDate1End.ToShortTimeString()
                </li>
                <li class="alternative-option-2">
                    @(summary.AlternativeDate2Start.ToLongDateString()),
                    @summary.AlternativeDate2Start.ToShortTimeString() to
                    @summary.AlternativeDate2End.ToShortTimeString()
                </li>
            </ol>
        </div>
        <table class="calculation">
            <tr><th>Estimated time required:</th><td class="time-required">@summary.ServiceDuration hours</td></tr>
            <tr>
                <th><span class="time-required">@summary.ServiceDuration hours</span> @('@') <span class="hour-price">$@summary.HourlyPrice</span></th>
                <td class="subtotal-price">$@summary.SubtotalPrice</td>
            </tr>
            <tr>
                <th>Loconomics service fee:</th>
                <td class="fee-pricee">$@summary.FeePrice</td>
            </tr>
            <tr>
                <th>Total estimated price:</th>
                <td class="total-price">$@summary.TotalPrice</td>
            </tr>
        </table>
    </fieldset>
    <fieldset class="actions">
        <button data-wizard-next-step="@Href(UrlUtil.LangPath + "Dashboard/Mailbox/")" class="button complete-booking next finish main-action">Complete booking</button>
    </fieldset>
</form>
