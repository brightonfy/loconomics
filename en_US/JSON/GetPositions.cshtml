@*
    This page is called to populate a JSON object with the Position Singular values available for a given Language and Country

    INPUT:
        serviceType
        languageID
        countryID
*@

@{
    // Prepare result struct
    var result = new Dictionary<string, object>();
    int resultCode = -1;
 
    try{
        // Input data
        var term = "%" + Request["serviceType"] + "%";
    
        // Process data
        var db = Database.Open("sqlloco");
        var sql = "EXEC GetPositions @0,1,1";
        var data = db.Query(sql, term);

        // Result format is different to feed the Autocomplete jQueryUI feature:
        if (UrlData.Count > 0 && UrlData[0].ToLower() == "autocomplete") {
            LcHelpers.ReturnJson(
                data.Select(p => new{label = p.PositionSingular, value = p.PositionID})
            );
        }
        
        result["Positions"] = data;
        
        //throw new Exception("Inside Test error");
        
        // Success
        resultCode = 0;

    } catch(Exception ex){
        result["ErrorMessage"] = ex.Message;
    }
    
    // Testing loading block:
    //System.Threading.Thread.Sleep(2000);
    //throw new Exception("Test error");
    
    // Output data
    LcHelpers.ReturnJsonResult(resultCode, result);
}