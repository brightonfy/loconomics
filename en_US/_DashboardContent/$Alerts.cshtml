@using WebMatrix.Data;
@using WebMatrix.WebData;
@{
    LcHelpers.SecurePage();
    
    dynamic alerts = LcData.GetActiveUserAlerts(WebSecurity.CurrentUserId);
}
<div id="dashboard-alerts" class="dashboard-alerts">
@if (alerts.Count > 0)
{
    <ul>
        @{
            // We need show the results in groups based on AlerType fields
            // We already get the data sorted by AlertTypeName, we implement
            // the group-by here in the view generation instead of do a 
            // database call for groups and other for each group alerts.
            // Simply remember last AlertTypeName and compare, when changed the new
            // group header must be showed
            var lastAlertType = "";
            foreach (var alert in alerts)
            {
                // Check AlerType for grouping
                if (lastAlertType != alert.AlertTypeName)
                {
                            <li class="group">
                                <h2>@alert.AlertTypeName</h2>
                                <span class="description">@alert.AlertTypeDescription</span>
                            </li>
                }
                lastAlertType = alert.AlertTypeName;

                string completeUrl = N.W(alert.AlertPageURL);
                if (completeUrl != null)
                {
                    if (alert.PositionSpecific)
                    {
                        completeUrl = completeUrl.Replace("@(PositionID)", alert.PositionID.ToString());
                    }
                    if (!completeUrl.StartsWith("javascript:"))
                    {
                        completeUrl = UrlUtil.LangPath + completeUrl;
                    }
                }
                        <li class="item">
                            @if (completeUrl != null)
                            {
                                <a class="alert-info" href="@completeUrl">@alert.AlertHeadlineDisplay 
                                @if (alert.PositionSpecific)
                                {
                                    <span class="alert-position">(@alert.PositionSingular)</span>
                                }
                                <span class="more">&gt;&gt;</span></a>
                            }
                            else
                            {
                                <span class="alert-info">@alert.AlertHeadlineDisplay</span>
                            }
                        </li>
            }
                }
    </ul>
} else {
    <div class="empty"><h2>Congratulations, you've completed all information!</h2></div>
}
</div>