@using WebMatrix.Data;
@{
    // Current position data record:
    var p = DashboardFunctions.GetUserCurrentPos();
    var n = p.PositionID;
    
    string photosFolder = UrlUtil.AppPath + "img/userphotos/u" + p.UserID.ToString() + "/";
    
    if (IsPost) {
        var delete = Request["delete-photo"].AsBool();
        var photoID = Request["PhotoID"].AsInt();
        if (delete) {
            using (var db = Database.Open("sqlloco")) {
                // Delete file from database, checking if exist more than one record
                // using the same image file, returning the PhotoAddress when there is
                // no more records sharing that address, and 'empty string' when there is more and
                // cannot be removed (without know the address, cannot be removed ;-)
                string photoAddress = db.QueryValue(@"
                    DECLARE @PhotoID int
                    SET @PhotoID = @0

                    -- Retrieving the PhotoAddress
                    DECLARE @address varchar(2073)
                    SELECT  @address = PhotoAddress
                    FROM    ProviderServicePhoto
                    WHERE   ProviderServicePhotoID = @PhotoID

                    DELETE FROM ProviderServicePhoto WHERE ProviderServicePhotoID = @PhotoID

                    -- Checking if there are more records with the same file, or returning the address
                    IF 0 = (SELECT  count(*)
                            FROM    ProviderServicePhoto
                            WHERE   PhotoAddress like @address)
                        SELECT @address As PhotoAddress
                    ELSE
                        SELECT '' As PhotoAddress
                ", photoID);
                
                if (!String.IsNullOrEmpty(photoAddress)) {
                    // Remove file from user folder
                    try{
                        File.Delete(Server.MapPath(photosFolder + photoAddress));
                    }catch{
                        throw new Exception("Photo file could not be deleted");
                    }
                }
            }
        } else {
            var caption = Request["photo-caption"];
            var isPrimary = Request["is-primary-photo"].AsBool();
        
            using (var db = Database.Open("sqlloco")) {
                db.Execute(@"
                    IF @2 = 1 BEGIN
                        UPDATE ProviderServicePhoto SET
                            IsPrimaryPhoto = 0
                        WHERE   UserID = @3 AND PositionID = @4
                    END

                    UPDATE ProviderServicePhoto SET
                        PhotoCaption = @1
                        ,IsPrimaryPhoto = @2
                    WHERE   ProviderServicePhotoID = @0 AND UserID = @3 AND PositionID = @4
                ", photoID, caption, isPrimary, p.UserID, p.PositionID);
            }
        }
    }
    
    dynamic photos = null;
    using (var db = Database.Open("sqlloco")) {
        photos = db.Query(@"
            SELECT [ProviderServicePhotoID]
                  ,[PhotoCaption]
                  ,[PhotoAddress]
                  ,[IsPrimaryPhoto]
              FROM [providerservicephoto]
              WHERE UserID = @0 AND PositionID = @1 AND Active = 1
              ORDER BY RankPosition
        ", p.UserID, p.PositionID);
    }
}
<p class="setting-instructions">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer justo lorem, egestas quis fermentum a, rutrum sed justo. Duis nulla tellus.
</p>
<div>
<form action="@(UrlUtil.LangPath)Dashboard/$PositionsPhotos/" method="post" class="positionphotos ajax ajax-box" id="position#@(n)-photos">
    <input type="hidden" name="PositionID" value="@p.PositionID"/>
    @Html.ValidationSummary(LcRessources.ValidationSummaryTitle)
    <div class="no-photos">
        <span class="positionphotos-tools-upload">Start <a href="#">uploading</a> a photo!</span>
    </div>
    <fieldset class="positionphotos-edit">
        <input type="hidden" name="PhotoID" value="" />
        <legend>Edit this photo:</legend>
        <ul>
            <li class="positionphotos-edit-photo"><img alt="Photo to edit" src="@(UrlUtil.AppPath)img/user-photo-no-selected.png" /></li>
            <li class="positionphotos-edit-caption">
                <label for="position#@(n)-photos-edit-caption">Caption:</label>
                <input type="text" id="position#@(n)-photos-edit-caption" name="photo-caption"/>
            </li>
            <li class="positionphotos-edit-primary">
                <h6>Make primary photo?</h6>
                <label>Yes<input type="radio" name="is-primary-photo" value="True"/></label>
                <label>No<input type="radio" name="is-primary-photo" value="False"/></label>
            </li>
            <li class="positionphotos-edit-delete">
                <a href="#">Delete this photo</a>
                <input type="hidden" name="delete-photo" value="False" />
            </li>
        </ul>
    </fieldset>
    <fieldset class="positionphotos-gallery">
        <legend>Stored photos:</legend>
        <ol>
            @foreach (var photo in photos)
            {
                <li id="UserPhoto-@photo.ProviderServicePhotoID" class="@(photo.IsPrimaryPhoto ? "selected is-primary-photo" : "")"><a href="#"><img alt="@photo.PhotoCaption" src="@(photosFolder + photo.PhotoAddress)"/></a><a class="edit" href="#">Edit</a></li>
            }
        </ol>
    </fieldset>
    <fieldset class="positionphotos-tools">
        <ul>
            <li class="positionphotos-tools-upload"><a href="#">Upload photos</a></li>
            <li class="positionphotos-tools-arrange">To arrange photos, click hover a photo and drag and drop. When finish, click save to remember the order.</li>
        </ul>
    </fieldset>
    <fieldset class="actions">
        <button class="save main-action" type="submit">Save</button>
    </fieldset>
    <script type="text/javascript">
        if (typeof (initPositionPhotos) == 'undefined')
            $(function () { initPositionPhotos(); });
        else
            initPositionPhotos();
    </script>
</form>
</div>