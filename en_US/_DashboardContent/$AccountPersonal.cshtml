@using WebMatrix.Data;
@{
    var idprefix = "account-personal";
    
    var u = DashboardFunctions.GetUserRow();
    
    // Initializing local data:
    var FirstName = Request["firstname"] ?? u.FirstName;
    var MiddleInitial = Request["middleinitial"] ?? u.MiddleIn;
    var LastName = Request["lastname"] ?? u.LastName;
    var SecondLastName = Request["secondlastname"] ?? u.SecondLastName;
    var MobilePhone = Request["mobilephone"] ?? u.MobilePhone;
    var AlternatePhone = Request["alternatephone"] ?? u.AlternatePhone;
    var Street1 = Request["streetaddress1"] ?? u.AddressLine1;
    var Street2 = Request["streetaddress2"] ?? u.AddressLine2;
    var City = Request["city"] ?? u.City;
    var State = Request["state"].IsInt() ? Request["state"].AsInt() : u.StateProvinceID != null ? (int)u.StateProvinceID : 0;
    string Zip = Request["zipcode"] ?? u.PostalCode;
    var Bio = Request["publicbio"] ?? u.PublicBio;
    string BirthYear = (Request["birthyear"] ?? u.BirthYear ?? "").ToString();
    var GenderID = Request["gender"] ?? u.GenderID ?? "";
    var IAuthZumigoVerification = (IsPost ? Request["auth-zumigo-verification"].AsBool() : u.IAuthZumigoVerification ?? false);
    var IAuthZumigoLocation = (IsPost ? Request["auth-zumigo-location"].AsBool() : u.IAuthZumigoLocation ?? false);

    // Initializing Validation rules
    Validation.RequireField("firstname", "First Name is required");
    Validation.RequireField("lastname", "Last Name is required");
    Validation.Add("middleinitial", Validator.StringLength(1, 0, "Middle Initial must be a unique letter"));
    Validation.Add("birthyear", Validator.Integer("Birth year is not valid"));
    int adultLimit = 16; // 16, 18, 19, 21 !!?
    Validation.Add("birthyear", Validator.Range(DateTime.MinValue.Year, DateTime.Today.Year - adultLimit, "Birth year is not valid"));
    
    if (IsPost && Validation.IsValid()) {
        
        if (!Zip.IsEmpty()) {
            int auxZip = LcValidators.ValidateZipCode(Zip, State);
            if (auxZip == 0) {
                ModelState.AddError("zipcode", "Zip code is not valid");
            } else {
                Zip = auxZip.ToString();
            }
        }
        
        if (ModelState.IsValid) {
            using (var db = Database.Open("sqlloco")){
                // Check what data changes to revoke verifications and update data:
                db.Execute(@"
                    DECLARE 
                    @UserID int
                    ,@FirstName varchar(50)
                    ,@MiddleIn varchar(1)
                    ,@LastName varchar(145)
                    ,@SecondLastName varchar(145)
                    ,@MobilePhone varchar(20)
                    ,@AlternatePhone varchar(20)
                    ,@AddressLine1 varchar(145)
                    ,@AddressLine2 varchar(145)
                    ,@City varchar(145)
                    ,@StateProvinceID int
                    ,@PostalCodeID int
                    ,@CountryID int
                    ,@PublicBio varchar(500)
                    ,@BirthYear int
                    ,@GenderID int
                    ,@IAuthZumigoVerification bit
                    ,@IAuthZumigoLocation bit

                    SET @UserID = @0
                    SET @FirstName = @1
                    SET @MiddleIn = @2
                    SET @LastName = @3
                    SET @SecondLastName = @16
                    SET @MobilePhone = @4
                    SET @AlternatePhone = @5
                    SET @AddressLine1 = @6
                    SET @AddressLine2 = @7
                    SET @City = @8
                    SET @StateProvinceID = @9
                    SET @PostalCodeID = @10
                    SET @CountryID = @17
                    SET @PublicBio = @11
                    SET @BirthYear = @12
                    SET @GenderID = @13
                    SET @IAuthZumigoVerification = @14
                    SET @IAuthZumigoLocation = @15


                    /* Do checks to revoke verifications on some changes */
                    -- @c var allow us check if data is equals (=1) or was changed (=0)
                    DECLARE @c int
                    -- Checking Full Name
                    SELECT  @c = count(*)
                    FROM    Users
                    WHERE   UserID = @UserID
                             AND
                            FirstName = @FirstName AND MiddleIn = @MiddleIn AND LastName = @LastName AND SecondLastName = @SecondLastName
                    IF @c = 0 BEGIN
                        -- Revoke social verifications (all VerificationCategoryID = 3)
                        UPDATE  UserVerification SET
                            VerificationStatusID = 3, -- revoked status
                            UpdatedDate = getdate()
                        WHERE   VerificationID IN (
                                    SELECT VerificationID
                                    FROM    Verification
                                    WHERE   VerificationCategoryID = 3
                                )

                        -- Revoke name verification (VerificationID=1)
                        UPDATE  UserVerification SET
                            VerificationStatusID = 3, -- revoked status
                            UpdatedDate = getdate()
                        WHERE   VerificationID = 1
                    END
                    -- Checking Address
                    SELECT  @c = count(*)
                    FROM    Users
                    WHERE   UserID = @UserID
                            AND AddressLine1 = @AddressLine1
                            AND AddressLine2 = @AddressLine2
                            AND City = @City
                            AND StateProvinceID = @StateProvinceID
                            AND PostalCodeID = @PostalCodeID
                            AND CountryID = @CountryID
                    IF @c = 0 BEGIN
                        -- Revoke address verification (VerificationID=2)
                        UPDATE  UserVerification SET
                            VerificationStatusID = 3, -- revoked status
                            UpdatedDate = getdate()
                        WHERE   VerificationID = 2
                    END
                    -- Checking Phone
                    SELECT  @c = count(*)
                    FROM    Users
                    WHERE   UserID = @UserID
                            AND MobilePhone = @MobilePhone
                            AND AlternatePhone = @AlternatePhone
                    IF @c = 0 BEGIN
                        -- Revoke phone verification (VerificationID=4)
                        UPDATE  UserVerification SET
                            VerificationStatusID = 3, -- revoked status
                            UpdatedDate = getdate()
                        WHERE   VerificationID = 4
                    END

                    /* Update Data */
                    UPDATE	Users
                    SET     FirstName = @FirstName
		                    ,MiddleIn = @MiddleIn
		                    ,LastName = @LastName
		                    ,SecondLastName = @SecondLastName
		                    ,MobilePhone = @MobilePhone
		                    ,AlternatePhone = @AlternatePhone
		                    ,AddressLine1 = @AddressLine1
		                    ,AddressLine2 = @AddressLine2
		                    ,City=@City
		                    ,StateProvinceID = @StateProvinceID
		                    ,PostalCodeID = @PostalCodeID
		                    ,CountryID = @CountryID
		                    ,PublicBio = @PublicBio
		                    ,BirthYear = @BirthYear
		                    ,GenderID = @GenderID
		                    ,IAuthZumigoVerification = @IAuthZumigoVerification
		                    ,IAuthZumigoLocation = @IAuthZumigoLocation
                            ,UpdatedDate = getdate()
                            ,ModifiedBy = 'sys'
                    WHERE   UserId = @UserID

                    -- Check Alerts related with user info:
                    EXEC TestAlertPersonalInfo @UserID
                    EXEC TestAlertProviderLogin @UserID
                    EXEC TestAlertBasicInfoVerification @UserID
                    EXEC TestAlertSocialMediaVerification @UserID
                ", u.UserID, FirstName, MiddleInitial, LastName, MobilePhone, AlternatePhone, Street1, Street2, City,
                 State, Zip, Bio, BirthYear.AsInt() == 0 ? null : BirthYear,
                 GenderID, IAuthZumigoVerification, IAuthZumigoLocation, SecondLastName, LcData.GetCurrentCountryID());
            }
            CommonHelpers.ReturnJsonResult(0, "Personal data updated!");
        }
    }
    dynamic genders = null, facebookVerification = null;
    using (var db = Database.Open("sqlloco")){
        genders = db.Query(@"
            SELECT  GenderID, GenderSingular
            FROM    Gender
            WHERE   LanguageID=@0 AND CountryID=@1
        ", 1, 1);
        var sqlGetVerification = @"
            SELECT  LastVerifiedDate,
                    UV.VerificationStatusID,
                    VS.VerificationStatusName
            FROM    UserVerification As UV
                     INNER JOIN
                    VerificationStatus As VS
                      ON UV.VerificationStatusID = VS.VerificationStatusID
                        AND LanguageID = @2 AND CountryID = @3
            WHERE   UserID = @0
                     AND
                    VerificationID = @1
        ";
        facebookVerification = db.QuerySingle(sqlGetVerification, u.UserID, 8, 1, 1);
    }
}
<p class="setting-instructions">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer justo lorem, egestas quis fermentum a, rutrum sed justo. Duis nulla tellus.
</p>
<div>
<form method="post" action="@(UrlUtil.LangPath)Dashboard/$AccountPersonal/" id="personal" class="ajax ajax-box">
    @CommonHelpers.GetValidationScripts()
    @Html.ValidationSummary(LcRessources.ValidationSummaryTitle)
    <div class="col col-2 col-2-1">
    <fieldset id="@idprefix-fs-contactinformation">
        <legend>Contact Information:</legend>
        <ul>
            <li><label for="@idprefix-firstname">First Name:</label><input id="@idprefix-firstname" type="text" name="firstname" placeholder="Your name" value="@FirstName" @Validation.GetHtml("firstname")/>
                @Html.ValidationMessage("firtname")
            </li>
            @if (LcData.GetCurrentCountryID() == 1)
            {
            <li><label for="@idprefix-middleinitial">Middle Initial:</label><input id="@idprefix-middleinitial" type="text" name="middleinitial" value="@MiddleInitial" @Validation.GetHtml("middleinitial")/>
                @Html.ValidationMessage("middleinitial")
            </li>
            }
            <li><label for="@idprefix-lastname">Last Name:</label><input id="@idprefix-lastname" type="text" name="lastname" value="@LastName" @Validation.GetHtml("lastname")/>
                @Html.ValidationMessage("lastname")
            </li>
            @if (LcData.GetCurrentCountryID() == 2)
            {
            <li><label for="@idprefix-secondlastname">Second Last Name:</label><input id="@idprefix-secondlastname" type="text" name="secondlastname" value="@SecondLastName" @Validation.GetHtml("secondlastname")/>
                @Html.ValidationMessage("secondlastname")
            </li>
            }
            <li><label for="@idprefix-mobilephone">Mobile Phone:</label><input id="@idprefix-mobilephone" type="text" name="mobilephone" value="@MobilePhone" @Validation.GetHtml("mobilephone")/>
                @Html.ValidationMessage("mobilephone")
            </li>
            <li><label for="@idprefix-alternatephone">Alternate Phone:</label><input id="@idprefix-alternatephone" type="text" name="alternatephone" value="@AlternatePhone" @Validation.GetHtml("alternatephone")/>
                @Html.ValidationMessage("alternatephone")
            </li>
        </ul>
    </fieldset>
    <fieldset id="@idprefix-fs-homeaddress">
        <legend>Home Address:</legend>
        <ul>
            <li><label for="@idprefix-streetaddress1">Street Address 1:</label><input id="@idprefix-streetaddress1" type="text" name="streetaddress1" value="@Street1" @Validation.GetHtml("streetaddress1")/>
                @Html.ValidationMessage("streetaddress1")
            </li>
            <li><label for="@idprefix-streetaddress2">Street Address 2:</label><input id="@idprefix-streetaddress2" type="text" name="streetaddress2" value="@Street2" @Validation.GetHtml("streetaddress2")/>
                @Html.ValidationMessage("streetaddress2")
            </li>
            <li><label for="@idprefix-city">City:</label><input id="@idprefix-city" type="text" name="city" value="@City" @Validation.GetHtml("city")/>
                @Html.ValidationMessage("city")
            </li>
            <li><label for="@idprefix-state">State:</label>
                <select id="@idprefix-state" name="state" @Validation.GetHtml("state")>
                    @CommonHelpers.StateProvinceOptions(State)
                </select>
                @Html.ValidationMessage("state")
            </li>
            <li><label for="@idprefix-zipcode">Zip Code:</label><input id="@idprefix-zipcode" type="text" name="zipcode" value="@Zip" @Validation.GetHtml("zipcode")/>
                @Html.ValidationMessage("zipcode")
            </li>
        </ul>
    </fieldset>
    <fieldset id="@idprefix-fs-personaldata">
        <legend>Personal Data:</legend>
        <ul>
            <li><label for="@idprefix-birthyear">Birth Year:</label>
                <input type="text" id="@idprefix-birthyear" name="birthyear" value="@BirthYear" @Validation.GetHtml("birthyear") />
                @Html.ValidationMessage("birthyear")
            </li>
            <li><label>Gender Identity:</label>
                @foreach (var gender in genders)
                {
                    <label class="gender">@gender.GenderSingular <input @CommonHelpers.IsChecked(@GenderID.ToString(), @gender.GenderID.ToString()) type="radio" name="gender" value="@gender.GenderID" /></label>
                }
                @Html.ValidationMessage("gender")
            </li>
        </ul>
    </fieldset>
    <fieldset id="@idprefix-fs-publicbio">
        <legend>Public Bio:</legend>
        <ul>
            <li><label for="@idprefix-publicbio">Public Bio:</label><textarea id="@idprefix-publicbio" name="publicbio" rows="7" @Validation.GetHtml("publicbio")>@Bio</textarea>
                @Html.ValidationMessage("publicbio")
            </li>
        </ul>
    </fieldset>
    </div>
    <div class="col col-2 col-2-2">
        <!--
        <fieldset id="@idprefix-fs-auths" class="auths">
            <legend>Authorizations:</legend>
            <ul>
                <li><input id="@idprefix-auth-zumigo-verification" value="True" @CommonHelpers.IsChecked("True", IAuthZumigoVerification.ToString()) type="checkbox" name="auth-zumigo-verification"/><label for="@idprefix-auth-zumigo-verification">I authorize Zumigo, Inc. to use my mobile phone number to verify my name, address, and phone number.</label></li>
                <li><input id="@idprefix-auth-zumigo-location" value="True" @CommonHelpers.IsChecked("True", IAuthZumigoLocation.ToString()) type="checkbox" name="auth-zumigo-location"/><label for="@idprefix-auth-zumigo-location">I authorize Loconomics to use Zumigo services for location-based messaging.</label></li>
            </ul>
        </fieldset>
        -->
        <fieldset id="@idprefix-fs-socialmedia" class="social-media">
            <legend>Social media verifications:</legend>
            <ul>
                <li class="facebook">
                    @RenderPage(UrlUtil.LangPath + "Account/_FacebookConnectButton.cshtml", "Verify", "json")
                    @if (facebookVerification != null)
                    {
                        <div class="verification-details">
                            Facebook verification status: @facebookVerification.VerificationStatusName since @facebookVerification.LastVerifiedDate
                            @if (facebookVerification.VerificationStatusID == 1)
                            {
                            <div class="warning">If you change your name, your Facebook verification will be revoked and you will need to verify again after save the changes.</div>
                            }
                        </div>
                    }
                </li>
                @*<li class="twitter"><a href="#"><img src="@Href(UrlUtil.AppPath + "img/connect-twitter.png")" alt="Sign in Twitter"/></a></li>
                <li class="linkedin"><a href="#"><img src="@Href(UrlUtil.AppPath + "img/connect-linkedin.png")" alt="Sign in LinkedIn"/></a></li>*@
            </ul>
        </fieldset>
    </div>
    <fieldset class="actions">
        <button class="save main-action" type="submit">Save</button>
    </fieldset>
</form>
</div>