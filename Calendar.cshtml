@*
    Generates an iCalendar output for the UserID calendar given in the first URL segment
    if the token given in the second URL segment math the user private-calendar-token.
    The third parameter MUST be 'ical'
*@
@{
    var userID = UrlData[0].AsInt();
    var token = UrlData[1];
    var f = UrlData[2];

    if (f == "ical" && userID > 0) {
        using (var db = Database.Open("sqlloco")) {
            if (db.QueryValue("SELECT PrivateCalendarToken FROM CalendarProviderAttributes WHERE UserID=@0", userID)
                == token) {
                var file = LcCalendar.Export(userID);
                Response.ContentType = "text/calendar";
                Response.WriteBinary(file.Item1, "text/calendar");
            }
        }
    }
}