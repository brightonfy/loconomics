@using WebMatrix.Data;
@{
    LcHelpers.ProviderPage();
    // Current provider data record:
    var p = LcData.UserInfo.GetUserRow();
    // Current position data record:
    var pos = LcData.UserInfo.GetUserCurrentPos();
    var n = pos.PositionID;
    
    if (p == null || pos == null){
        var inputdataerrormessage = "Please correct any errors and click save";
        if (IsPost){
            LcHelpers.ReturnJsonError(-1, inputdataerrormessage);
        }else{
            throw new Exception(inputdataerrormessage);
        }
    }
    
    string pageToLoad = "";
    dynamic pricingtypes = null;

    using (var db = Database.Open("sqlloco")){
        
        // TODO: Get Customer Type Id   
        var clienttypeid = PageData["ClientTypeID"] = 1;
        
        // Get our Pricing Type ID:
        pricingtypes = LcData.GetPositionPricingTypes(pos.PositionID, clienttypeid);
        if (pricingtypes.Count == 1) {
            // TEMPORARY SUPPORT for the old way, unique pricing type per position:
            switch ((int)pricingtypes[0].PricingTypeID) {
                /* NEVER IMPLEMENTED
                 * case 1: // Hours
                    pageToLoad = "_ProviderHoursType.cshtml";
                    break;
                 */
                case 2: // Custom
                    pageToLoad = "_ProviderCustomType.cshtml";
                    break;
                case 3: // Packages
                    pageToLoad = "$ProviderPackagesType.cshtml";
                    break;
            }
        } else {
            // NEW WAY: Multiple pricing types, based on PackageBase
            pageToLoad = "$ProviderPricingTypes.cshtml";
        }
    }
    
    var idprefix = PageData["idprefix"] = "position#" + n + "-pricing";
}
@if (!String.IsNullOrEmpty(pageToLoad))
{
<p class="setting-instructions">
Keeping your prices available and realistic is a good idea. If you need help determining what’s right, <a href="mailto:providerhelp@loconomics.com">let us know</a>.
</p>
<div>
    @RenderPage(LcUrl.RenderLangPath + "PricingWizard/" + pageToLoad, new { PricingWizardClasses = "positionpricing", PositionID = pos.PositionID, PricingTypes = pricingtypes })
</div>
}
else
{
    <p>We're currently researching how best to calculate pricing estimates for this position.  We'd love to get your input; please <a href="mailto:providerhelp@loconomics.com">e-mail us</a>.</p>
}